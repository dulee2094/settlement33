<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블라인드 합의 제안 - SafeHappE</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/blind_proposal.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar - Focus Mode -->
        <aside class="sidebar">
            <a href="index.html" class="logo">
                <div class="logo-grid">
                    <span class="logo-row-en logo-en-left">Safe</span>
                    <span class="logo-row-en logo-en-right">HappE.</span>
                    <span class="logo-row-kr logo-kr-left">세이프</span>
                    <span class="logo-row-kr logo-kr-right">합의</span>
                </div>
            </a>

            <!-- Context Info -->
            <div
                style="padding: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">현재 조율 중인 사건</div>
                <div id="sidebarCaseNumber"
                    style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 5px;">-</div>
                <div style="font-size: 0.85rem; color: #aaa;"><i class="fas fa-user"></i> 상대방: <span
                        id="sidebarCounterparty">-</span></div>
            </div>

            <nav class="nav-links">
                <div class="nav-item active"
                    style="margin-bottom: 30px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                    <i class="fas fa-search-dollar"></i>
                    <span>블라인드 제안 중</span>
                </div>

                <div class="nav-item" onclick="location.href='case_detail.html'"
                    style="cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">
                    <i class="fas fa-arrow-left"></i>
                    <span>사건 상세 현황으로 복귀</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <h2 style="margin-bottom: 5px;">블라인드 합의 제안</h2>
                    <p style="color: var(--text-muted);">감정 소모 없이 희망 금액을 조율해보세요.</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-glass" style="font-size: 0.85rem;" onclick="location.href='dashboard.html'">
                        <i class="fas fa-arrow-left" style="margin-right: 6px;"></i> 뒤로가기
                    </button>
                    <span class="status-badge" id="statusBadge"
                        style="background: var(--bg-card); color: var(--text-muted);">제안 대기중</span>
                </div>
            </div>

            <!-- Blind Proposal Section -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                <!-- Left Column: Input Form -->
                <div class="glass-card" id="myProposalCard">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-edit" style="color: #3b82f6;"></i> 나의 제안 등록
                    </h3>

                    <!-- Convergence Guide -->
                    <div
                        style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #fbbf24;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> <strong>주의
                            (Irreversible)</strong><br>
                        한 번 제안한 금액은 되돌릴 수 없으며, 다음 차수 제안 시 <strong>"합의 수렴 원칙"</strong>에 따라 본인에게 더 유리한 금액(지급액 축소/수령액 증액)으로
                        변경할 수 없습니다. 신중하게 제안해주세요.
                    </div>

                    <div
                        style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <!-- Position Toggle -->
                        <div
                            style="display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px;">
                            <button id="pos-payer" onclick="selectPosition('payer')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(59, 130, 246, 0.2); color: white; border-color: #3b82f6; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-usd"></i> 지급 (주겠습니다)
                            </button>
                            <button id="pos-receiver" onclick="selectPosition('receiver')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255,255,255,0.05); color: #888; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-heart"></i> 수령 (받겠습니다)
                            </button>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">합의
                                희망 금액 (만원)</label>
                            <div style="position: relative;">
                                <input type="number" id="myAmount" placeholder="예: 500"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; color: white; font-size: 1.1rem; padding-right: 50px;">
                                <span
                                    style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #888;">만원</span>
                            </div>
                            <p id="amountGuideText" style="font-size: 0.8rem; color: #888; margin-top: 8px;">
                                상대방에게 지급할 금액을 입력하세요.
                            </p>
                        </div>

                        <!-- Duration -->
                        <div style="margin-bottom: 20px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">제안
                                유효 기간</label>
                            <div style="display: flex; gap: 8px;">
                                <div class="duration-btn" id="btn-0.25" onclick="selectDuration(0.25)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    6시간</div>
                                <div class="duration-btn active" id="btn-1" onclick="selectDuration(1)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #4ade80; background: #4ade80; color: #000; font-weight: bold; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">
                                    1일</div>
                                <div class="duration-btn" id="btn-3" onclick="selectDuration(3)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    3일</div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="submitProposal()"
                            style="width: 100%; padding: 15px; font-size: 1rem;">
                            제안 등록하기
                        </button>
                        <div
                            style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #888; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 6px;">
                            <span style="margin-right: 10px;">현재 <strong style="color: #60a5fa;"><span
                                        id="currentRoundDisplay">-</span>라운드</strong> 진행 중</span>
                            <span style="color: #444;">|</span>
                            <span style="margin-left: 10px;">남은 기회: <strong style="color: #4ade80;"><span
                                        id="leftCount">?</span>회</strong></span>
                        </div>
                    </div>

                    <!-- History -->
                    <div>
                        <h4 style="margin-bottom: 15px; font-size: 1rem; color: #cbd5e1;">나의 제안 이력</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); text-align: left;">
                                    <th style="padding: 10px;">차수</th>
                                    <th style="padding: 10px;">일시</th>
                                    <th style="padding: 10px;">금액(원)</th>
                                    <th style="padding: 10px;">결과</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Column: Dynamic Status Panel -->
                <div class="glass-card"
                    style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 480px;">

                    <!-- Priority 1: Midpoint Agreement Notification (Highest) -->
                    <div id="midpointResultArea"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;"></div>

                    <!-- Priority 2: Opponent Proposed Notification (NEW - Moved from Top) -->
                    <div id="opponentProposedNotification"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <!-- Priority 3: Extension Request Notification -->
                    <div id="extensionNotification"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <!-- Priority 4.2: Midpoint Agreement (Blind Consent) -->
                    <div id="midpointAgreementState"
                        style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                            ⚖️
                        </div>
                        <h3 style="color: #fff; margin-bottom: 15px;">합의 가능 구간(10%) 진입!</h3>
                        <div
                            style="background: rgba(251, 191, 36, 0.1); border: 1px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <p style="color: #fca5a5; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-lock"></i> 금액 비공개
                            </p>
                            <p style="color: #cbd5e1; line-height: 1.6; margin: 0;">
                                양측의 제안 차이가 <strong>10% 이내</strong>로 좁혀졌습니다.<br>
                                두 금액의 <strong>[정확한 중간값]</strong>으로<br>
                                합의금을 확정하시겠습니까?
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="btnRejectMidpoint" class="btn btn-glass"
                                style="flex: 1; border: 1px solid rgba(255,100,100,0.3); color: #fca5a5;">
                                아니오<br><span style="font-size: 0.8rem;">협상 계속</span>
                            </button>
                            <button id="btnAgreeMidpoint" class="btn btn-primary"
                                style="flex: 1.5; background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);">
                                네, 동의합니다<br><span style="font-size: 0.8rem;">즉시 타결</span>
                            </button>
                        </div>
                        <p style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">
                            * 양측 모두 동의 시 합의가 성립되며 금액이 공개됩니다.
                        </p>
                    </div>

                    <!-- Priority 4.5: Analysis Confirmation (Two-Step Verification) -->
                    <div id="analysisReadyState" style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                            🎉
                        </div>
                        <h3 style="color: #fff; margin-bottom: 15px;">1라운드 분석 완료!</h3>
                        <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 30px;">
                            양측의 제안이 모두 등록되어<br>
                            AI 격차 분석이 완료되었습니다.<br>
                            결과를 확인하시겠습니까?
                        </p>
                        <button class="btn btn-primary" onclick="viewAnalysisResult()"
                            style="width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 50px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="fas fa-search-dollar" style="margin-right: 10px;"></i> 분석 결과 확인하기
                        </button>
                        <p style="margin-top: 15px; font-size: 0.8rem; color: #64748b;">
                            * 결과를 확인하면 1라운드가 종료됩니다.
                        </p>
                    </div>

                    <!-- Priority 5: Result Analysis State (Graph) -->
                    <div id="resultState" style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <!-- Round End Badge -->
                        <div id="roundEndBadge"
                            style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 15px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            🛑 라운드 종료
                        </div>

                        <div id="gapTitle"
                            style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #fff;"></div>
                        <div id="gapDesc" style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem;">
                        </div>

                        <!-- Gauge Visual -->
                        <div
                            style="width: 100%; max-width: 300px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin: 0 auto 30px auto; position: relative; overflow: hidden;">
                            <div id="gapGauge"
                                style="height: 100%; width: 0%; background: #4ade80; border-radius: 5px; transition: width 1s ease;">
                            </div>
                        </div>

                        <!-- Info Grid -->
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; text-align: left;">
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">나의 제안</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;" id="myCurrentDisplay">-
                                </div>
                            </div>
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;"
                                id="rangeHintBox">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">금액 차이(Gap)</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;">분석 중...</div>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 15px; color: #fff; font-size: 1rem;">SafeHappE AI 조언</h4>
                        <div
                            style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #3b82f6; text-align: left; font-size: 0.9rem; color: #cbd5e1; line-height: 1.6;">
                            현재 격차를 줄이기 위해서는 상대방의 입장을 고려한 조금 더 유연한 제안이 필요할 수 있습니다. <br>
                            만약 격차가 10% 이내라면, <strong>중간 지점</strong>에서의 합의를 강력히 권장합니다.
                        </div>

                        <!-- Proceed to Next Round Button (Static button removed in favor of dynamic renderNextRoundAction) -->
                    </div>

                    <!-- Priority 6: Default Waiting State -->
                    <div id="waitingState" style="display: block; animation: fade-in 0.5s ease-out; height: 100%;">
                        <!-- Default Initial Content (Will be updated by JS if needed, but good to have a base) -->
                        <div
                            style="width:100%; height:100%; display:flex; flex-direction:column; justify-content:center;">
                            <div
                                style="background: rgba(59, 130, 246, 0.1); color: #60a5fa; display: inline-block; padding: 6px 15px; border-radius: 20px; font-size: 0.9rem; margin: 0 auto 20px auto; border: 1px solid rgba(59, 130, 246, 0.3); font-weight: 600;">
                                📍 1라운드 진행 중
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                                <!-- My Status -->
                                <div class="glass-card"
                                    style="padding: 20px; border: 1px solid rgba(251, 191, 36, 0.5); background: rgba(251, 191, 36, 0.05);">
                                    <div style="font-size: 3rem; margin-bottom: 10px;">✏️</div>
                                    <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 5px;">나의 상태</div>
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #fbbf24;">입력 대기</div>
                                </div>
                                <!-- Opponent Status -->
                                <div class="glass-card"
                                    style="padding: 20px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05);">
                                    <div style="font-size: 3rem; margin-bottom: 10px;">👤</div>
                                    <div style="font-size: 0.9rem; color: #cbd5e1; margin-bottom: 5px;">상대방 상태</div>
                                    <div style="font-size: 1.1rem; font-weight: bold; color: #64748b;">입력 대기</div>
                                </div>
                            </div>

                            <div
                                style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; text-align: left;">
                                <h4 style="color: #fff; margin-bottom: 15px; font-size: 1rem;"><i
                                        class="fas fa-info-circle" style="color: #60a5fa; margin-right: 8px;"></i>진행 안내
                                </h4>
                                <ul
                                    style="list-style: none; padding: 0; margin: 0; color: #94a3b8; font-size: 0.9rem; line-height: 1.8;">
                                    <li>• 희망 금액을 등록하면 상대방에게 <strong>알림이 전송</strong>됩니다.</li>
                                    <li>• 양측 모두 등록 시 <strong>AI 격차 분석</strong>이 즉시 시작됩니다.</li>
                                    <li>• 제안하신 금액은 타결 전까지 <strong>상대방에게 비공개</strong>됩니다.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Core Logic Script -->
                <script src="js/modules/proposal_api.js"></script>
                <script src="js/modules/proposal_ui.js"></script>
                <script src="js/modules/proposal_state.js"></script>
                <script src="js/modules/proposal_handler.js"></script>
                <script src="js/blind_proposal.js"></script>
            </div>
        </main>

        <!-- Onboarding Guide Modal (Single Page) -->
        <div id="guideModal" class="guide-modal-overlay">
            <div class="guide-modal" style="max-width: 700px; padding: 0; overflow: hidden; border-radius: 24px;">
                <!-- Header -->
                <div
                    style="background: linear-gradient(135deg, #1e293b, #0f172a); padding: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 2.5rem; margin-bottom: 15px;">⚖️</div>
                    <h2 style="color: white; margin: 0; font-size: 1.5rem;">블라인드 합의 제안 규칙</h2>
                    <p style="color: #94a3b8; margin: 10px 0 0; font-size: 0.95rem;">공정하고 안전한 합의를 위해 4가지 원칙을 꼭 확인하세요.
                    </p>
                </div>

                <!-- 4 Rules Grid -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 30px; background: #fff;">

                    <!-- Rule 1 -->
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">🙈</div>
                        <h4 style="color: #1e293b; margin-bottom: 8px; font-weight: bold;">철저한 비공개</h4>
                        <p style="color: #64748b; font-size: 0.9rem; line-height: 1.5; margin: 0;">상대에게 내 제안 금액이<br>절대
                            보이지 않습니다.</p>
                    </div>

                    <!-- Rule 2 -->
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">🚦</div>
                        <h4 style="color: #1e293b; margin-bottom: 8px; font-weight: bold;">색상으로 격차 확인</h4>
                        <p style="color: #64748b; font-size: 0.9rem; line-height: 1.5; margin: 0;">금액 대신 격차 수준만<br>신호등
                            색상으로 알려줍니다.</p>
                    </div>

                    <!-- Rule 3 -->
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">⚡</div>
                        <h4 style="color: #1e293b; margin-bottom: 8px; font-weight: bold;">제안 기회 5회</h4>
                        <p style="color: #64748b; font-size: 0.9rem; line-height: 1.5; margin: 0;">기회는 단 5번뿐입니다.<br>신중하게
                            제안하세요.</p>
                    </div>

                    <!-- Rule 4 -->
                    <div style="text-align: center; padding: 15px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">🤖</div>
                        <h4 style="color: #1e293b; margin-bottom: 8px; font-weight: bold;">AI 자동 타결</h4>
                        <p style="color: #64748b; font-size: 0.9rem; line-height: 1.5; margin: 0;">격차가 10% 이내로
                            줄어들면<br>중간값으로 즉시 합의됩니다.</p>
                    </div>
                </div>

                <!-- Footer Action -->
                <div
                    style="background: #f8fafc; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #e2e8f0;">
                    <label
                        style="color: #64748b; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="dontShowAgain" style="transform: scale(1.2);"> 다시 보지 않기
                    </label>
                    <button onclick="closeGuide()"
                        style="padding: 12px 30px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);">
                        확인했습니다
                    </button>
                </div>
            </div>
        </div>


</html>