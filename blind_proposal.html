<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블라인드 합의 제안 - SafeHappE</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar - Focus Mode -->
        <aside class="sidebar">
            <a href="index.html" class="logo">
                <div class="logo-grid">
                    <span class="logo-row-en logo-en-left">Safe</span>
                    <span class="logo-row-en logo-en-right">HappE.</span>
                    <span class="logo-row-kr logo-kr-left">세이프</span>
                    <span class="logo-row-kr logo-kr-right">합의</span>
                </div>
            </a>

            <!-- Context Info -->
            <div
                style="padding: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">현재 조율 중인 사건</div>
                <div style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 5px;">2024형제11111</div>
                <div style="font-size: 0.85rem; color: #aaa;"><i class="fas fa-user"></i> 상대방: 김철수</div>
            </div>

            <nav class="nav-links">
                <div class="nav-item active"
                    style="margin-bottom: 30px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                    <i class="fas fa-search-dollar"></i>
                    <span>블라인드 제안 중</span>
                </div>

                <div class="nav-item" onclick="location.href='case_detail.html'"
                    style="cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">
                    <i class="fas fa-arrow-left"></i>
                    <span>사건 상세 현황으로 복귀</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <h2 style="margin-bottom: 5px;">블라인드 합의 제안</h2>
                    <p style="color: var(--text-muted);">감정 소모 없이 희망 금액을 조율해보세요.</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-glass" style="font-size: 0.85rem;" onclick="location.href='dashboard.html'">
                        <i class="fas fa-arrow-left" style="margin-right: 6px;"></i> 뒤로가기
                    </button>
                    <span class="status-badge" id="statusBadge"
                        style="background: var(--bg-card); color: var(--text-muted);">제안 대기중</span>
                </div>
            </div>

            <!-- Blind Proposal Section -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">

                <!-- Left: My Proposal -->
                <div class="glass-card" style="height: 100%;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h3>나의 희망 금액</h3>
                        <span
                            style="font-size: 0.8rem; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 12px;">비공개
                            안전 보장 <i class="fas fa-lock"></i></span>
                    </div>

                    <div style="text-align: center; margin-bottom: 40px;">
                        <!-- Limit Badge -->
                        <div style="margin-bottom: 20px;">
                            <span
                                style="background: rgba(255, 99, 71, 0.1); border: 1px solid rgba(255, 99, 71, 0.3); color: #ff6347; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-exclamation-circle"></i> 남은 제안 횟수: <strong id="leftCount">3</strong> /
                                3회
                            </span>
                        </div>

                        <p id="amountGuideText" style="color: var(--text-muted); margin-bottom: 10px;">상대방에게 지급할 금액을
                            입력하세요.</p>
                        <div style="position: relative; max-width: 300px; margin: 0 auto;">
                            <span
                                style="position: absolute; right: 25px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: var(--text-muted); font-weight: bold;">만원</span>
                            <input type="number" id="myAmount" class="form-input"
                                style="padding-right: 70px; font-size: 1.5rem; font-weight: bold; text-align: center;"
                                placeholder="0">
                        </div>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 5px; margin-bottom: 25px;">* 예: 300만원 입력 시
                            300만 입력</p>

                        <!-- Position Selector -->
                        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 30px;">
                            <button id="pos-payer" class="btn position-btn active" onclick="selectPosition('payer')"
                                style="flex: 1; max-width: 140px; padding: 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #fff; border-radius: 8px; font-size: 1rem; font-weight: 600; transition: all 0.3s; box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; gap: 6px;">
                                💸 드릴게요
                            </button>
                            <button id="pos-receiver" class="btn position-btn" onclick="selectPosition('receiver')"
                                style="flex: 1; max-width: 140px; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #888; border-radius: 8px; font-size: 1rem; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                🤲 받을게요
                            </button>
                        </div>

                        <!-- Duration Selector -->
                        <div style="max-width: 350px; margin: 0 auto; text-align: left;">
                            <label
                                style="font-size: 0.9rem; color: var(--text-muted); display: block; margin-bottom: 8px;">제안
                                유효 기간 <span style="font-size:0.7rem; color:#666;">(기한 내 미응답 시 자동 만료)</span></label>
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button id="btn-1" class="btn duration-btn" onclick="selectDuration(1)"
                                    style="flex:1; padding: 10px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; font-size: 0.9rem;">1일</button>
                                <button id="btn-3" class="btn duration-btn" onclick="selectDuration(3)"
                                    style="flex:1; padding: 10px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; font-size: 0.9rem;">3일</button>
                                <button id="btn-7" class="btn duration-btn active" onclick="selectDuration(7)"
                                    style="flex:1; padding: 10px; background: #4ade80; color: #000; border: 1px solid #4ade80; border-radius: 8px; transition: all 0.3s; font-size: 0.9rem; font-weight: bold; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">1주일</button>
                            </div>
                        </div>
                    </div>

                    <!-- Removed AI Analysis Guide Block -->

                    <button class="btn btn-primary" style="width: 100%;" onclick="submitProposal()">제안 등록하기</button>
                </div>

                <!-- Right: Gap Analysis Result -->
                <div class="glass-card"
                    style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">

                    <div id="waitingState">
                        <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 20px; opacity: 0.3;">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <h3>상대방의 제안을 기다리고 있습니다</h3>
                        <p style="color: var(--text-muted); margin-top: 10px;">양측 모두 제안을 등록하면<br>금액 차이(Gap) 범위만 알려드립니다.
                        </p>
                    </div>

                    <div id="resultState" style="display: none; width: 100%;">
                        <div style="margin-bottom: 30px;">
                            <span style="font-size: 0.9rem; color: var(--secondary);">분석 완료</span>
                            <h2 style="font-size: 2rem; margin-top: 10px;" id="gapTitle">금액 차이가 큽니다</h2>
                        </div>

                        <!-- Gauge Visual -->
                        <div
                            style="width: 100%; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px; position: relative;">
                            <div id="gapGauge"
                                style="width: 80%; height: 100%; background: linear-gradient(90deg, #ff4d4d, #f9cb28); border-radius: 10px; transition: width 1s ease;">
                            </div>

                            <!-- Markers -->
                            <div style="position: absolute; left: 20%; top: 25px; font-size: 0.7rem; color: #aaa;">|
                                100만 이내</div>
                            <div style="position: absolute; left: 50%; top: 25px; font-size: 0.7rem; color: #aaa;">|
                                500만 이내</div>
                            <div style="position: absolute; left: 80%; top: 25px; font-size: 0.7rem; color: #aaa;">|
                                1000만 이상</div>
                        </div>

                        <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 30px;" id="gapDesc">
                            희망 금액 차이가 <strong>500만원 ~ 1000만원</strong> 사이입니다.<br>
                            직접적인 대화보다는 전문가나 중재를 고려해보시는 것이 좋습니다.
                        </p>

                        <div id="actionButtons">
                            <button class="btn btn-glass" style="margin-right: 10px;">금액 수정 제안</button>
                            <button class="btn btn-primary"
                                style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">변호사 중재 신청</button>
                        </div>
                    </div>

                </div>

            </div>

            <!-- Proposal History Section -->
            <div class="glass-card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-history"></i> 제안 히스토리</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted);">
                                <th style="padding: 15px; font-weight: 500;">회차</th>
                                <th style="padding: 15px; font-weight: 500;">일시</th>
                                <th style="padding: 15px; font-weight: 500;">나의 제안 (만)</th>
                                <th style="padding: 15px; font-weight: 500;">분석 결과</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="4" style="padding: 30px; text-align: center; color: var(--text-muted);">
                                    아직 제안 내역이 없습니다.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Proposal History State
        let proposalHistory = [];
        let proposalCount = 0;
        const MAX_PROPOSALS = 3;

        // Position Selection
        let currentPosition = 'payer'; // Default: Paying

        // Initialize: Check Status from Server
        document.addEventListener('DOMContentLoaded', async () => {
            await initializePage();
        });

        async function initializePage() {
            const caseId = localStorage.getItem('current_case_id');
            const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
            const userId = userInfo.id || 1; // Fallback

            try {
                // Fetch Proposal Status
                // Assuming GET /api/case/proposal returning history and counts
                // For MVP, if not implemented, we rely on local state or basic init.
                // But let's try to fetch if possible.
                // Since GET method wasn't explicitly seen, we'll assume we start fresh or relying on 'submit' return.
                // For now, update UI counts.
                updateCountUI();
            } catch (e) {
                console.error("Init Error", e);
            }
        }

        function selectPosition(type) {
            currentPosition = type;
            const payerBtn = document.getElementById('pos-payer');
            const receiverBtn = document.getElementById('pos-receiver');
            const guideText = document.getElementById('amountGuideText');

            // Reset styles
            [payerBtn, receiverBtn].forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'rgba(255, 255, 255, 0.05)';
                btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                btn.style.color = '#888';
                btn.style.boxShadow = 'none';
            });

            // Activate specific button
            const targetBtn = type === 'payer' ? payerBtn : receiverBtn;
            targetBtn.classList.add('active');
            targetBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            targetBtn.style.borderColor = '#3b82f6';
            targetBtn.style.color = '#fff';
            targetBtn.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.2)';

            // Update Text
            if (type === 'payer') {
                guideText.textContent = "상대방에게 지급할 금액을 입력하세요.";
            } else {
                guideText.textContent = "상대방에게 받고 싶은 금액을 입력하세요.";
            }
        }

        // Duration Selection
        let selectedDuration = 7; // default 1 week

        function selectDuration(days) {
            selectedDuration = days;
            // Update UI
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'rgba(255, 255, 255, 0.05)';
                btn.style.color = '#888';
                btn.style.border = '1px solid rgba(255,255,255,0.1)';
            });

            const activeBtn = document.getElementById(`btn-${days}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#4ade80';
                activeBtn.style.color = '#000';
                activeBtn.style.fontWeight = 'bold';
                activeBtn.style.border = '1px solid #4ade80';
                activeBtn.style.boxShadow = '0 0 10px rgba(74, 222, 128, 0.3)';
            }
        }

        async function submitProposal() {
            // 1. Check Limits
            if (proposalCount >= MAX_PROPOSALS) {
                return alert('제안 횟수(3회)를 모두 소진했습니다. 더 이상 수정 제안할 수 없습니다.');
            }

            const rawInput = parseInt(document.getElementById('myAmount').value);
            if (!rawInput) return alert('희망 금액을 입력해주세요.');

            const positionText = currentPosition === 'payer' ? '지급' : '수령';
            if (!confirm(`[남은 제안 횟수: ${MAX_PROPOSALS - proposalCount - 1}회]\n\n${rawInput}만원을 '${positionText}'하는 조건으로 제안하시겠습니까?\n(유효기간: ${selectedDuration}일)\n제안 즉시 상대방에게 알림이 발송됩니다.`)) return;

            // Convert Man-won to Won
            const myAmount = rawInput * 10000;

            const btn = document.querySelector('.btn-primary');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 분석 및 전송중...';
            btn.disabled = true;

            const caseId = localStorage.getItem('current_case_id');
            const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
            const userId = userInfo.id || 1;

            try {
                // REAL API CALL
                const res = await fetch('/api/proposal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ caseId, userId, amount: myAmount, duration: selectedDuration, position: currentPosition })
                });
                const data = await res.json();

                if (!data.success) {
                    alert('오류 발생: ' + data.error);
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                    return;
                }

                // Increase Count
                proposalCount++;
                updateCountUI();

                // Check Status from Server Response
                // Status: 'waiting' (Opponent hasn't proposed yet) OR 'analyzed' (Both proposed)
                if (data.status === 'waiting') {
                    // Update UI to 'Waiting' State more explicitly
                    document.getElementById('waitingState').style.display = 'block';
                    document.getElementById('waitingState').innerHTML = `
                         <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3>제안이 성공적으로 등록되었습니다</h3>
                        <p style="color: var(--text-muted); margin-top: 10px;">
                            상대방이 아직 제안을 등록하지 않았습니다.<br>
                            상대방도 제안을 등록하면 <strong>즉시 분석 결과</strong>가 표시됩니다.
                        </p>
                        <button class="btn btn-glass" onclick="location.reload()" style="margin-top:20px;">새로고침</button>
                    `;
                    document.getElementById('resultState').style.display = 'none';

                    // Add to history as 'waiting'
                    addToHistory(myAmount, '대기 중', '#888');

                } else if (data.status === 'analyzed') {
                    // Logic: Both have proposed.
                    // Calculate GAP and Show Result (Logic moved from frontend to data drive)
                    // Note: Ideally Server should return the Gap Level/Percent.
                    // For now, we assume Server returns 'data.data.diff' (absolute diff).
                    // We need 'opponentAmount' to fully visualize standard frontend logic or just use diff.

                    // For visualization, we need opponent amount or gap percent.
                    // Let's infer opponent amount roughly or calculate gap percent if diff is provided.
                    // Diff = |My - Opponent|
                    // If we don't know opponent amount, we can't calculate exact % cleanly without it.
                    // But let's assume for this 'Blind' concept, the server MIGHT return the 'Analysis Level' directly to avoid cheating?
                    // Or we just fetch the diff and calculate based on myAmount.
                    // Let's assume a simple Gap Calc on Frontend for now using the Diff.
                    // Opponent = My +/- Diff. We don't know if higher or lower.
                    // Actually, % difference is based on Average usually.
                    // Let's simplify: Gap % = (Diff / MyAmount) * 100 (Roughly).
                    // Better: Server should return the Analysis Result info.

                    // Let's fallback to the previous Visualization Logic but populated with REAL 'data.data.diff'.
                    // We will simulate the 'Analysis' display using the Diff.

                    const diff = data.data.diff;
                    // We don't know Opponent Amount exactly (Blind), but to visualize range we might guess.
                    // Or, just use Diff to determine Level.

                    // Estimate Gap % relative to My Amount (User centric view)
                    let gapPercent = (diff / myAmount) * 100;

                    showAnalysisResult(gapPercent, myAmount, diff);
                    addToHistory(myAmount, '분석 완료', '#4ade80');
                }

            } catch (err) {
                console.error(err);
                alert('서버 통신 오류');
            } finally {
                if (proposalCount < MAX_PROPOSALS) {
                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                } else {
                    btn.textContent = '제안 횟수 초과';
                }
            }
        }

        function showAnalysisResult(gapPercent, myAmount, diff) {
            document.getElementById('waitingState').style.display = 'none';
            document.getElementById('resultState').style.display = 'block';

            const gapTitle = document.getElementById('gapTitle');
            const gapDesc = document.getElementById('gapDesc');
            const gapGauge = document.getElementById('gapGauge');
            const statusBadge = document.getElementById('statusBadge');
            const actionButtons = document.getElementById('actionButtons');

            let color, title, desc, width, badgeText;

            if (gapPercent <= 10) {
                color = '#4ade80'; title = "축하합니다! 의견이 거의 일치합니다";
                desc = "제안하신 금액과 상대방의 희망 금액 차이가 <strong>10% 이내</strong>입니다.";
                width = '98%'; badgeText = "성사 확실";
            } else if (gapPercent <= 30) {
                color = '#3b82f6'; title = "긍정적인 조율 단계입니다";
                desc = "의견 차이가 크지 않습니다. 조금만 더 조율하면 합의점을 찾을 수 있습니다.";
                width = '75%'; badgeText = "조율 가능";
            } else if (gapPercent <= 60) {
                color = '#facc15'; title = "희망 금액의 차이가 큽니다";
                desc = "생각의 차이가 존재합니다. 신중한 재고가 필요합니다.";
                width = '50%'; badgeText = "차이 발생";
            } else {
                color = '#ef4444'; title = "입장 차이가 매우 큽니다";
                desc = "상대방과 금액에 대한 기준이 많이 다릅니다.";
                width = '25%'; badgeText = "큰 격차";
            }

            gapTitle.innerHTML = title;
            gapDesc.innerHTML = desc;
            gapGauge.style.width = width;
            gapGauge.style.background = color;
            gapGauge.style.boxShadow = `0 0 20px ${color}`;
            statusBadge.textContent = badgeText;
            statusBadge.style.color = color;
            statusBadge.style.border = `1px solid ${color}`;

            // Range Hint Sim
            // Blind Range: My +/- Diff/2 is not correct.
            // Just show broad range: MyAmount +/- Diff (Very rough) or just hide specifics.
            // Let's show "Gap Amount" roughly.
            const rangeBox = document.getElementById('rangeHintBox');
            if (rangeBox) {
                rangeBox.innerHTML = `
                    <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">금액 차이(Gap)</div>
                     <div style="font-size: 1.2rem; font-weight: bold; color: #fff;">
                        약 ${diff.toLocaleString()}원 차이
                    </div>
                 `;
            }
        }

        function addToHistory(amount, result, color) {
            const now = new Date();
            const timeString = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            const historyItem = { round: proposalCount, time: timeString, amount: amount, result: result, color: color };
            proposalHistory.unshift(historyItem);

            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = proposalHistory.map(item => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 15px;">${item.round}차</td>
                    <td style="padding: 15px; color: var(--text-muted); font-size: 0.9rem;">${item.time}</td>
                    <td style="padding: 15px; font-weight: bold;">${item.amount.toLocaleString()}</td>
                    <td style="padding: 15px;">
                        <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; border: 1px solid ${item.color}; color: ${item.color}; background: rgba(255,255,255,0.05);">
                            ${item.result}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateCountUI() {
            const leftCountEl = document.getElementById('leftCount');
            if (leftCountEl) leftCountEl.textContent = MAX_PROPOSALS - proposalCount;
        }

        // Navigation Helper
        function goToAccountPage() {
            localStorage.setItem('active_tab_on_load', 'account');
            location.href = 'case_detail.html';
        }

        function resetForNewProposal() {
            location.reload();
        }
    </script>
</body>

</html>