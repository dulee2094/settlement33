<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블라인드 합의 제안 - SafeHappE</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Midpoint Agreement Functions -->
    <script src="midpoint_agreement.js"></script>
    <style>
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: rgba(59, 130, 246, 0.6);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                border-color: rgba(59, 130, 246, 1);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                border-color: rgba(59, 130, 246, 0.6);
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar - Focus Mode -->
        <aside class="sidebar">
            <a href="index.html" class="logo">
                <div class="logo-grid">
                    <span class="logo-row-en logo-en-left">Safe</span>
                    <span class="logo-row-en logo-en-right">HappE.</span>
                    <span class="logo-row-kr logo-kr-left">세이프</span>
                    <span class="logo-row-kr logo-kr-right">합의</span>
                </div>
            </a>

            <!-- Context Info -->
            <div
                style="padding: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">현재 조율 중인 사건</div>
                <div id="sidebarCaseNumber"
                    style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 5px;">-</div>
                <div style="font-size: 0.85rem; color: #aaa;"><i class="fas fa-user"></i> 상대방: <span
                        id="sidebarCounterparty">-</span></div>
            </div>

            <nav class="nav-links">
                <div class="nav-item active"
                    style="margin-bottom: 30px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                    <i class="fas fa-search-dollar"></i>
                    <span>블라인드 제안 중</span>
                </div>

                <div class="nav-item" onclick="location.href='case_detail.html'"
                    style="cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">
                    <i class="fas fa-arrow-left"></i>
                    <span>사건 상세 현황으로 복귀</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <h2 style="margin-bottom: 5px;">블라인드 합의 제안</h2>
                    <p style="color: var(--text-muted);">감정 소모 없이 희망 금액을 조율해보세요.</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-glass" style="font-size: 0.85rem;" onclick="location.href='dashboard.html'">
                        <i class="fas fa-arrow-left" style="margin-right: 6px;"></i> 뒤로가기
                    </button>
                    <span class="status-badge" id="statusBadge"
                        style="background: var(--bg-card); color: var(--text-muted);">제안 대기중</span>
                </div>
            </div>

            <!-- Notification Area -->
            <div id="notificationArea" style="display: none; margin-bottom: 20px;"></div>

            <!-- Blind Proposal Section -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                <!-- Left Column: Input Form -->
                <div class="glass-card" id="myProposalCard">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-edit" style="color: #3b82f6;"></i> 나의 제안 등록
                    </h3>

                    <!-- Convergence Guide -->
                    <div
                        style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #fbbf24;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> <strong>주의
                            (Irreversible)</strong><br>
                        한 번 제안한 금액은 되돌릴 수 없으며, 다음 차수 제안 시 <strong>"합의 수렴 원칙"</strong>에 따라 본인에게 더 유리한 금액(지급액 축소/수령액 증액)으로
                        변경할 수 없습니다. 신중하게 제안해주세요.
                    </div>

                    <div
                        style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <!-- Position Toggle -->
                        <div
                            style="display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px;">
                            <button id="pos-payer" onclick="selectPosition('payer')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(59, 130, 246, 0.2); color: white; border-color: #3b82f6; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-usd"></i> 지급 (주겠습니다)
                            </button>
                            <button id="pos-receiver" onclick="selectPosition('receiver')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255,255,255,0.05); color: #888; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-heart"></i> 수령 (받겠습니다)
                            </button>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">합의
                                희망 금액 (만원)</label>
                            <div style="position: relative;">
                                <input type="number" id="myAmount" placeholder="예: 500"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; color: white; font-size: 1.1rem; padding-right: 50px;">
                                <span
                                    style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #888;">만원</span>
                            </div>
                            <p id="amountGuideText" style="font-size: 0.8rem; color: #888; margin-top: 8px;">
                                상대방에게 지급할 금액을 입력하세요.
                            </p>
                        </div>

                        <!-- Duration -->
                        <div style="margin-bottom: 20px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">제안
                                유효 기간</label>
                            <div style="display: flex; gap: 8px;">
                                <div class="duration-btn" id="btn-0.25" onclick="selectDuration(0.25)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    6시간</div>
                                <div class="duration-btn active" id="btn-1" onclick="selectDuration(1)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #4ade80; background: #4ade80; color: #000; font-weight: bold; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">
                                    1일</div> <!-- Default Active -->
                                <div class="duration-btn" id="btn-3" onclick="selectDuration(3)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    3일</div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="submitProposal()"
                            style="width: 100%; padding: 15px; font-size: 1rem;">
                            제안 등록하기
                        </button>
                        <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #888;">
                            남은 제안 횟수: <span id="leftCount" style="color: #4ade80; font-weight: bold;">?</span>회
                        </div>
                    </div>

                    <!-- History -->
                    <div>
                        <h4 style="margin-bottom: 15px; font-size: 1rem; color: #cbd5e1;">나의 제안 이력</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); text-align: left;">
                                    <th style="padding: 10px;">차수</th>
                                    <th style="padding: 10px;">일시</th>
                                    <th style="padding: 10px;">금액(원)</th>
                                    <th style="padding: 10px;">결과</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Column: Result / Status -->
                <div class="glass-card"
                    style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 480px;">

                    <!-- 1. Waiting State -->
                    <div id="waitingState" style="display: block;">
                        <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 20px; opacity: 0.3;">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <h3 style="color: var(--text-muted);">아직 제안을 등록하지 않았습니다</h3>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                            좌측에서 희망 금액을 입력하고<br>제안을 등록해주세요.
                        </p>
                    </div>

                    <!-- 2. Result State (Analysis) -->
                    <div id="resultState" style="display: none; width: 100%;">
                        <div id="gapTitle"
                            style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #fff;"></div>
                        <div id="gapDesc" style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem;">
                        </div>

                        <!-- Gauge Visual -->
                        <div
                            style="width: 100%; max-width: 300px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin: 0 auto 30px auto; position: relative; overflow: hidden;">
                            <div id="gapGauge"
                                style="height: 100%; width: 0%; background: #4ade80; border-radius: 5px; transition: width 1s ease;">
                            </div>
                        </div>

                        <!-- Info Grid -->
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; text-align: left;">
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">나의 제안</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;" id="myCurrentDisplay">-
                                </div>
                            </div>
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;"
                                id="rangeHintBox">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">금액 차이(Gap)</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;">분석 중...</div>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 15px; color: #fff; font-size: 1rem;">SafeHappE AI 조언</h4>
                        <div
                            style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #3b82f6; text-align: left; font-size: 0.9rem; color: #cbd5e1; line-height: 1.6;">
                            현재 격차를 줄이기 위해서는 상대방의 입장을 고려한 조금 더 유연한 제안이 필요할 수 있습니다. <br>
                            만약 격차가 10% 이내라면, <strong>중간 지점</strong>에서의 합의를 강력히 권장합니다.
                        </div>
                    </div>
                </div>

                <script>
                    // Proposal History State
                    let proposalHistory = [];
                    let proposalCount = 0;
                    let maxLimit = 5; // Default Base

                    // Extension State
                    let isExtended = false;
                    let iAgreedExtension = false;
                    let oppAgreedExtension = false;

                    // Midpoint Agreement State
                    let midpointProposed = false;
                    let midpointAmount = 0;
                    let iAgreedMidpoint = false;
                    let oppAgreedMidpoint = false;
                    let bothAgreedMidpoint = false;

                    // Position Selection
                    let currentPosition = 'payer'; // Default: Paying

                    // Initialize: Check Status from Server
                    document.addEventListener('DOMContentLoaded', async () => {
                        await initializePage();
                    });

                    async function initializePage() {
                        const caseId = localStorage.getItem('current_case_id');
                        const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
                        const userId = userInfo.id;

                        // UI Binding
                        const caseNum = localStorage.getItem('current_case_number') || localStorage.getItem('current_case_title') || '-';
                        const counterParty = localStorage.getItem('current_counterparty') || '알 수 없음';

                        const elCase = document.getElementById('sidebarCaseNumber');
                        const elCounter = document.getElementById('sidebarCounterparty');
                        if (elCase) elCase.textContent = caseNum;
                        if (elCounter) elCounter.textContent = counterParty;

                        if (!caseId || !userId) {
                            alert("로그인 정보가 없거나 사건이 선택되지 않았습니다.");
                            location.href = 'dashboard.html';
                            return;
                        }

                        try {
                            const res = await fetch(`/api/case/proposal?caseId=${caseId}&userId=${userId}`);
                            const data = await res.json();

                            if (data.success) {
                                // 1. Update Extension State
                                isExtended = data.isExtended;
                                iAgreedExtension = data.iAgreed;
                                oppAgreedExtension = data.oppAgreed;

                                // Update Max Limit
                                maxLimit = isExtended ? 8 : 5;

                                // 2. Update Local State
                                proposalCount = data.myProposalCount;
                                if (data.myLastProposal) {
                                    window.myLastProposalAmount = data.myLastProposal.amount;
                                    if (data.myLastProposal.position) {
                                        selectPosition(data.myLastProposal.position);
                                    }
                                }
                                updateCountUI();

                                // 3. Notification Logic
                                const notifArea = document.getElementById('notificationArea');

                                // Check Midpoint Status First (Highest Priority)
                                const midpointShown = await checkMidpointStatus();

                                if (midpointShown) {
                                    // Already shown by checkMidpointStatus
                                }
                                // Priority 1: Extension Request from Opponent (If I haven't agreed yet)
                                else if (oppAgreedExtension && !iAgreedExtension && !isExtended) {
                                    notifArea.style.display = 'block';
                                    notifArea.innerHTML = `
                                        <div class="glass-card" style="background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; display: flex; align-items: center; gap: 20px; padding: 25px; animation: pulse-border 2s infinite;">
                                            <div style="width: 60px; height: 60px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);">
                                                <i class="fas fa-handshake" style="color: white; font-size: 1.8rem;"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <h3 style="margin: 0 0 8px 0; color: #fff; font-size: 1.2rem;">🔄 상대방이 협상 연장을 요청했습니다</h3>
                                                <p style="margin: 0; color: #cbd5e1; font-size: 0.95rem; line-height: 1.5;">
                                                    이 제안을 수락하면 양측 모두 제안 기회가 <strong>3회 추가</strong>됩니다.<br>
                                                    아직 합의 가능성이 보인다면 연장에 동의해주세요.
                                                </p>
                                            </div>
                                            <div style="text-align: right;">
                                                <button class="btn btn-primary" onclick="requestExtension()" style="background: #f59e0b; border:none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);">
                                                    연장 동의하기 (+3회)
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                                // Priority 2: Opponent Proposed (Standard Blind Alert)
                                else if (data.hasOpponentProposed && proposalCount === 0) {
                                    notifArea.style.display = 'block';
                                    notifArea.innerHTML = `
                                        <div class="glass-card" style="background: rgba(59, 130, 246, 0.1); border: 1px solid #3b82f6; display: flex; align-items: center; gap: 20px; padding: 25px; animation: pulse-border 2s infinite;">
                                            <div style="width: 60px; height: 60px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);">
                                                <i class="fas fa-envelope-open-text" style="color: white; font-size: 1.8rem;"></i>
                                            </div>
                                            <div style="flex: 1;">
                                                <h3 style="margin: 0 0 8px 0; color: #fff; font-size: 1.2rem;">🔔 상대방이 합의 희망 금액을 제안했습니다!</h3>
                                                <p style="margin: 0; color: #cbd5e1; font-size: 0.95rem; line-height: 1.5;">
                                                    상대방은 기다리고 있습니다. <br>
                                                    지금 본인의 금액을 입력하면, <strong>즉시 AI 격차 분석 결과</strong>를 확인하실 수 있습니다.
                                                </p>
                                            </div>
                                            <div style="text-align: right;">
                                                <span style="font-size: 0.8rem; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 20px; color: #94a3b8;">
                                                    <i class="fas fa-lock"></i> 상대방 금액 비공개 중
                                                </span>
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    notifArea.style.display = 'none';
                                }

                                // 4. Restore State
                                // 4. Restore State
                                if (proposalCount > 0) {
                                    if (data.status === 'analyzed') {
                                        const diff = data.data.diff;
                                        const myAmount = window.myLastProposalAmount;
                                        if (myAmount) {
                                            const gapPercent = (diff / myAmount) * 100;
                                            showAnalysisResult(gapPercent, myAmount, diff);
                                            addToHistory(myAmount, '분석 완료', '#4ade80');
                                        }
                                    } else {
                                        document.getElementById('waitingState').style.display = 'block';
                                        document.getElementById('resultState').style.display = 'none';

                                        if (window.myLastProposalAmount) {
                                            addToHistory(window.myLastProposalAmount, '대기 중', '#888');
                                        }

                                        if (data.hasOpponentProposed) {
                                            // If analyzed failed but opponent proposed (should be rare now)
                                            document.getElementById('waitingState').innerHTML = `
                                                <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
                                                <h3>제안이 등록되었습니다</h3>
                                                <p style="color: var(--text-muted); margin-top: 10px;">결과를 불러오는 중입니다...</p>
                                             `;
                                        } else {
                                            document.getElementById('waitingState').innerHTML = `
                                                <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
                                                <h3>제안이 등록되었습니다</h3>
                                                <p style="color: var(--text-muted); margin-top: 10px;">상대방이 제안하면 분석 결과가 표시됩니다.</p>
                                             `;
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.error("Init Error", e);
                        }
                    }

                    function selectPosition(type) {
                        currentPosition = type;
                        const payerBtn = document.getElementById('pos-payer');
                        const receiverBtn = document.getElementById('pos-receiver');
                        const guideText = document.getElementById('amountGuideText');

                        // Reset styles
                        [payerBtn, receiverBtn].forEach(btn => {
                            btn.classList.remove('active');
                            btn.style.background = 'rgba(255, 255, 255, 0.05)';
                            btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                            btn.style.color = '#888';
                            btn.style.boxShadow = 'none';
                        });

                        // Activate specific button
                        const targetBtn = type === 'payer' ? payerBtn : receiverBtn;
                        targetBtn.classList.add('active');
                        targetBtn.style.background = 'rgba(59, 130, 246, 0.2)';
                        targetBtn.style.borderColor = '#3b82f6';
                        targetBtn.style.color = '#fff';
                        targetBtn.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.2)';

                        // Update Text
                        if (type === 'payer') {
                            guideText.textContent = "상대방에게 지급할 금액을 입력하세요.";
                        } else {
                            guideText.textContent = "상대방에게 받고 싶은 금액을 입력하세요.";
                        }
                    }

                    // Duration Selection
                    let selectedDuration = 1; // default 1 day

                    function selectDuration(days) {
                        selectedDuration = days;
                        // Update UI
                        document.querySelectorAll('.duration-btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.style.background = 'rgba(255, 255, 255, 0.05)';
                            btn.style.color = '#888';
                            btn.style.border = '1px solid rgba(255,255,255,0.1)';
                        });

                        const activeBtn = document.getElementById(`btn-${days}`);
                        if (activeBtn) {
                            activeBtn.classList.add('active');
                            activeBtn.style.background = '#4ade80';
                            activeBtn.style.color = '#000';
                            activeBtn.style.fontWeight = 'bold';
                            activeBtn.style.border = '1px solid #4ade80';
                            activeBtn.style.boxShadow = '0 0 10px rgba(74, 222, 128, 0.3)';
                        }
                    }



                    window.submitProposal = async () => {
                        const rawInput = document.getElementById('myAmount').value.replace(/,/g, '');
                        if (!rawInput) return alert('희망 금액을 입력해주세요.');

                        // Global variable selectedDuration is updated by selectDuration()
                        if (!selectedDuration) return alert('제안 유효 기간을 선택해주세요.');

                        // Double check limit before sending (UI sync)
                        if (proposalCount >= maxLimit) {
                            // Check extension possibility again
                            if (proposalCount === 5 && !isExtended) {
                                if (confirm('기본 제안 횟수(5회)를 모두 소진했습니다.\n\n상대방에게 [협상 연장]을 요청하시겠습니까?\n(양측 동의 시 3회 추가)')) {
                                    requestExtension();
                                    return;
                                }
                                return;
                            } else {
                                return alert('제안 횟수를 모두 소진했습니다.');
                            }
                        }

                        const positionText = currentPosition === 'payer' ? '지급' : '수령';
                        const remaining = maxLimit - proposalCount - 1;
                        if (!confirm(`[남은 제안 횟수: ${remaining}회]\n\n${parseInt(rawInput).toLocaleString()}만원을 '${positionText}'하는 조건으로 제안하시겠습니까?\n한 번 제안하면 되돌릴 수 없습니다.`)) return;

                        const myAmount = rawInput * 10000;
                        const btn = document.querySelector('.btn-primary');
                        const originalBtnText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 분석 및 전송중...';
                        btn.disabled = true;

                        const caseId = localStorage.getItem('current_case_id');
                        const userInfoStr = localStorage.getItem('user_info');
                        let userId = 1; // Default fallback

                        if (userInfoStr) {
                            try {
                                const userInfo = JSON.parse(userInfoStr);
                                if (userInfo.id) userId = userInfo.id;
                            } catch (e) {
                                console.error('Token parsing error', e);
                            }
                        }

                        console.log('Submitting proposal:', { caseId, userId, amount: myAmount });

                        try {
                            const res = await fetch('/api/case/proposal', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ caseId, userId, amount: myAmount, duration: selectedDuration, position: currentPosition })
                            });
                            const data = await res.json();

                            if (!data.success) {
                                alert('오류 발생: ' + data.error);
                                btn.innerHTML = originalBtnText;
                                btn.disabled = false;
                                return;
                            }

                            // Check Midpoint Trigger
                            if (data.midpointTriggered) {
                                alert(`✨ 10% 이내 합의 제안!\n\n양측의 제안 금액이 10% 이내로 매우 가깝습니다!\n중간 금액 ${(data.midpointAmount / 10000).toLocaleString()}만원으로 합의하시겠습니까?\n\n[확인]을 누르면 합의 제안 화면으로 이동합니다.`);
                                location.reload();
                                return;
                            }

                            // Increase Count
                            proposalCount++;
                            if (data.myLastProposal) {
                                window.myLastProposalAmount = myAmount;
                            } else {
                                window.myLastProposalAmount = myAmount;
                            }

                            updateCountUI();

                            if (data.status === 'waiting') {
                                document.getElementById('waitingState').style.display = 'block';
                                document.getElementById('waitingState').innerHTML = `
                                    <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
                                    <h3>제안이 성공적으로 등록되었습니다</h3>
                                    <p style="color: var(--text-muted); margin-top: 10px;">상대방이 제안하면 분석 결과가 표시됩니다.</p>
                                    <button class="btn btn-glass" onclick="location.reload()" style="margin-top:20px;">새로고침</button>
                                `;
                                document.getElementById('resultState').style.display = 'none';
                                addToHistory(myAmount, '대기 중', '#888');

                            } else if (data.status === 'analyzed') {
                                const diff = data.data.diff;
                                let gapPercent = (diff / myAmount) * 100;
                                showAnalysisResult(gapPercent, myAmount, diff);
                                addToHistory(myAmount, '분석 완료', '#4ade80');
                            }

                        } catch (err) {
                            console.error(err);
                            alert('서버 통신 오류: ' + err.message);
                        } finally {
                            if (proposalCount < maxLimit) {
                                btn.innerHTML = originalBtnText;
                                btn.disabled = false;
                            } else {
                                updateCountUI();
                            }
                        }
                    }

                    function showAnalysisResult(gapPercent, myAmount, diff) {
                        document.getElementById('waitingState').style.display = 'none';
                        document.getElementById('resultState').style.display = 'block';

                        const gapTitle = document.getElementById('gapTitle');
                        const gapDesc = document.getElementById('gapDesc');
                        const gapGauge = document.getElementById('gapGauge');
                        const statusBadge = document.getElementById('statusBadge');

                        let color, title, desc, width, badgeText;

                        if (gapPercent <= 10) {
                            color = '#4ade80'; title = "축하합니다! 의견이 거의 일치합니다";
                            desc = "제안하신 금액과 상대방의 희망 금액 차이가 <strong>10% 이내</strong>입니다.";
                            width = '98%'; badgeText = "성사 확실";
                        } else if (gapPercent <= 30) {
                            color = '#3b82f6'; title = "긍정적인 조율 단계입니다";
                            desc = "의견 차이가 크지 않습니다. 조금만 더 조율하면 합의점을 찾을 수 있습니다.";
                            width = '75%'; badgeText = "조율 가능";
                        } else if (gapPercent <= 60) {
                            color = '#facc15'; title = "희망 금액의 차이가 큽니다";
                            desc = "생각의 차이가 존재합니다. 신중한 재고가 필요합니다.";
                            width = '50%'; badgeText = "차이 발생";
                        } else {
                            color = '#ef4444'; title = "입장 차이가 매우 큽니다";
                            desc = "상대방과 금액에 대한 기준이 많이 다릅니다.";
                            width = '25%'; badgeText = "큰 격차";
                        }

                        if (gapTitle) gapTitle.innerHTML = title;
                        if (gapDesc) gapDesc.innerHTML = desc;
                        if (gapGauge) {
                            gapGauge.style.width = width;
                            gapGauge.style.background = color;
                            gapGauge.style.boxShadow = `0 0 20px ${color}`;
                        }
                        if (statusBadge) {
                            statusBadge.textContent = badgeText;
                            statusBadge.style.color = color;
                            statusBadge.style.border = `1px solid ${color}`;
                        }
                    }

                    function addToHistory(amount, result, color) {
                        const now = new Date();
                        const timeString = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                        const historyItem = { round: proposalCount, time: timeString, amount: amount, result: result, color: color };
                        proposalHistory.unshift(historyItem);

                        const tbody = document.getElementById('historyTableBody');
                        tbody.innerHTML = proposalHistory.map(item => `
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 15px;">${item.round}차</td>
                                <td style="padding: 15px; color: var(--text-muted); font-size: 0.9rem;">${item.time}</td>
                                <td style="padding: 15px; font-weight: bold;">${item.amount.toLocaleString()}</td>
                                <td style="padding: 15px;">
                                    <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; border: 1px solid ${item.color}; color: ${item.color}; background: rgba(255,255,255,0.05);">
                                        ${item.result}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                    }

                    function updateCountUI() {
                        const leftCountEl = document.getElementById('leftCount');
                        if (leftCountEl) leftCountEl.textContent = Math.max(0, maxLimit - proposalCount);

                        const btn = document.querySelector('.btn-primary');
                        if (proposalCount >= maxLimit) {
                            // Check if extended
                            if (isExtended && proposalCount >= 8) {
                                btn.textContent = '최대 제안 횟수 초과 (종료)';
                                btn.disabled = true;
                                btn.onclick = null;
                            } else if (!isExtended && proposalCount >= 5) {
                                // Default Limit Reached -> Show Extension Option
                                if (iAgreedExtension) {
                                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 상대방 동의 대기중...';
                                    btn.disabled = true;
                                    btn.style.background = '#4b5563';
                                } else {
                                    btn.innerHTML = '<i class="fas fa-handshake"></i> 제안 횟수 연장 요청 (3회 추가)';
                                    btn.disabled = false;
                                    btn.onclick = requestExtension;
                                    btn.style.background = '#f59e0b';
                                    btn.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.4)';
                                }
                            } else {
                                // Regular limit reached (shouldn't happen if logic correct above)
                                btn.textContent = '제안 횟수 초과';
                                btn.disabled = true;
                            }
                        } else {
                            // Normal State
                            btn.textContent = '제안 등록하기';
                            btn.disabled = false;
                            btn.onclick = submitProposal;
                            btn.style.background = ''; // reset
                            btn.style.boxShadow = '';
                        }
                    }

                    async function requestExtension() {
                        if (!confirm("제안 횟수 연장을 요청하시겠습니까?\n\n상대방도 동의하면 총 제안 기회가 3회 추가됩니다.\n(상대방에게 알림이 발송됩니다)")) return;

                        const btn = document.querySelector('.btn-primary');
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 요청 중...';
                        btn.disabled = true;

                        try {
                            const caseId = localStorage.getItem('current_case_id');
                            const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
                            const userId = userInfo.id;

                            const res = await fetch('/api/case/proposal/extend', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ caseId, userId })
                            });
                            const data = await res.json();

                            if (data.success) {
                                alert("연장 요청(또는 동의)이 완료되었습니다.\n상대방도 동의하면 즉시 횟수가 추가됩니다.");
                                location.reload();
                            } else {
                                alert("요청 실패: " + data.error);
                                location.reload();
                            }
                        } catch (e) {
                            console.error(e);
                            alert("오류 발생");
                        }
                    }

                    function resetForNewProposal() {
                        location.reload();
                    }
                </script>
            </div>
        </main>
    </div>
</body>

</html>