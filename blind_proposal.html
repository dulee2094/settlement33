<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블라인드 합의 제안 - SafeHappE</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar - Focus Mode -->
        <aside class="sidebar">
            <a href="index.html" class="logo">
                <div class="logo-grid">
                    <span class="logo-row-en logo-en-left">Safe</span>
                    <span class="logo-row-en logo-en-right">HappE.</span>
                    <span class="logo-row-kr logo-kr-left">세이프</span>
                    <span class="logo-row-kr logo-kr-right">합의</span>
                </div>
            </a>

            <!-- Context Info -->
            <div
                style="padding: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">현재 조율 중인 사건</div>
                <div style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 5px;">2024형제11111</div>
                <div style="font-size: 0.85rem; color: #aaa;"><i class="fas fa-user"></i> 상대방: 김철수</div>
            </div>

            <nav class="nav-links">
                <div class="nav-item active"
                    style="margin-bottom: 30px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                    <i class="fas fa-search-dollar"></i>
                    <span>블라인드 제안 중</span>
                </div>

                <div class="nav-item" onclick="location.href='case_detail.html'"
                    style="cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">
                    <i class="fas fa-arrow-left"></i>
                    <span>사건 상세 현황으로 복귀</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <h2 style="margin-bottom: 5px;">블라인드 합의 제안</h2>
                    <p style="color: var(--text-muted);">감정 소모 없이 희망 금액을 조율해보세요.</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-glass" style="font-size: 0.85rem;" onclick="location.href='dashboard.html'">
                        <i class="fas fa-arrow-left" style="margin-right: 6px;"></i> 뒤로가기
                    </button>
                    <span class="status-badge" id="statusBadge"
                        style="background: var(--bg-card); color: var(--text-muted);">제안 대기중</span>
                </div>
            </div>

            <!-- Blind Proposal Section -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">

                <!-- Left: My Proposal -->
                <div class="glass-card" style="height: 100%;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h3>나의 희망 금액</h3>
                        <span
                            style="font-size: 0.8rem; padding: 4px 10px; background: rgba(255,255,255,0.1); border-radius: 12px;">비공개
                            안전 보장 <i class="fas fa-lock"></i></span>
                    </div>

                    <div style="text-align: center; margin-bottom: 40px;">
                        <!-- Limit Badge -->
                        <div style="margin-bottom: 20px;">
                            <span
                                style="background: rgba(255, 99, 71, 0.1); border: 1px solid rgba(255, 99, 71, 0.3); color: #ff6347; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;">
                                <i class="fas fa-exclamation-circle"></i> 남은 제안 횟수: <strong id="leftCount">3</strong> /
                                3회
                            </span>
                        </div>

                        <p id="amountGuideText" style="color: var(--text-muted); margin-bottom: 10px;">상대방에게 지급할 금액을
                            입력하세요.</p>
                        <div style="position: relative; max-width: 300px; margin: 0 auto;">
                            <span
                                style="position: absolute; right: 25px; top: 50%; transform: translateY(-50%); font-size: 1.2rem; color: var(--text-muted); font-weight: bold;">만원</span>
                            <input type="number" id="myAmount" class="form-input"
                                style="padding-right: 70px; font-size: 1.5rem; font-weight: bold; text-align: center;"
                                placeholder="0">
                        </div>
                        <p style="font-size: 0.8rem; color: #666; margin-top: 5px; margin-bottom: 25px;">* 예: 300만원 입력 시
                            300만 입력</p>

                        <!-- Position Selector -->
                        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 30px;">
                            <button id="pos-payer" class="btn position-btn active" onclick="selectPosition('payer')"
                                style="flex: 1; max-width: 140px; padding: 12px; background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; color: #fff; border-radius: 8px; font-size: 1rem; font-weight: 600; transition: all 0.3s; box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; gap: 6px;">
                                💸 드릴게요
                            </button>
                            <button id="pos-receiver" class="btn position-btn" onclick="selectPosition('receiver')"
                                style="flex: 1; max-width: 140px; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #888; border-radius: 8px; font-size: 1rem; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                🤲 받을게요
                            </button>
                        </div>

                        <!-- Duration Selector -->
                        <div style="max-width: 350px; margin: 0 auto; text-align: left;">
                            <label
                                style="font-size: 0.9rem; color: var(--text-muted); display: block; margin-bottom: 8px;">제안
                                유효 기간 <span style="font-size:0.7rem; color:#666;">(기한 내 미응답 시 자동 만료)</span></label>
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <button id="btn-1" class="btn duration-btn" onclick="selectDuration(1)"
                                    style="flex:1; padding: 10px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; font-size: 0.9rem;">1일</button>
                                <button id="btn-3" class="btn duration-btn" onclick="selectDuration(3)"
                                    style="flex:1; padding: 10px; background: rgba(255,255,255,0.05); color: #888; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.3s; font-size: 0.9rem;">3일</button>
                                <button id="btn-7" class="btn duration-btn active" onclick="selectDuration(7)"
                                    style="flex:1; padding: 10px; background: #4ade80; color: #000; border: 1px solid #4ade80; border-radius: 8px; transition: all 0.3s; font-size: 0.9rem; font-weight: bold; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">1주일</button>
                            </div>
                        </div>
                    </div>

                    <!-- Removed AI Analysis Guide Block -->

                    <button class="btn btn-primary" style="width: 100%;" onclick="submitProposal()">제안 등록하기</button>
                </div>

                <!-- Right: Gap Analysis Result -->
                <div class="glass-card"
                    style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">

                    <div id="waitingState">
                        <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 20px; opacity: 0.3;">
                            <i class="fas fa-user-secret"></i>
                        </div>
                        <h3>상대방의 제안을 기다리고 있습니다</h3>
                        <p style="color: var(--text-muted); margin-top: 10px;">양측 모두 제안을 등록하면<br>금액 차이(Gap) 범위만 알려드립니다.
                        </p>
                    </div>

                    <div id="resultState" style="display: none; width: 100%;">
                        <div style="margin-bottom: 30px;">
                            <span style="font-size: 0.9rem; color: var(--secondary);">분석 완료</span>
                            <h2 style="font-size: 2rem; margin-top: 10px;" id="gapTitle">금액 차이가 큽니다</h2>
                        </div>

                        <!-- Gauge Visual -->
                        <div
                            style="width: 100%; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-bottom: 30px; position: relative;">
                            <div id="gapGauge"
                                style="width: 80%; height: 100%; background: linear-gradient(90deg, #ff4d4d, #f9cb28); border-radius: 10px; transition: width 1s ease;">
                            </div>

                            <!-- Markers -->
                            <div style="position: absolute; left: 20%; top: 25px; font-size: 0.7rem; color: #aaa;">|
                                100만 이내</div>
                            <div style="position: absolute; left: 50%; top: 25px; font-size: 0.7rem; color: #aaa;">|
                                500만 이내</div>
                            <div style="position: absolute; left: 80%; top: 25px; font-size: 0.7rem; color: #aaa;">|
                                1000만 이상</div>
                        </div>

                        <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 30px;" id="gapDesc">
                            희망 금액 차이가 <strong>500만원 ~ 1000만원</strong> 사이입니다.<br>
                            직접적인 대화보다는 전문가나 중재를 고려해보시는 것이 좋습니다.
                        </p>

                        <div id="actionButtons">
                            <button class="btn btn-glass" style="margin-right: 10px;">금액 수정 제안</button>
                            <button class="btn btn-primary"
                                style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">변호사 중재 신청</button>
                        </div>
                    </div>

                </div>

            </div>

            <!-- Proposal History Section -->
            <div class="glass-card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 20px;"><i class="fas fa-history"></i> 제안 히스토리</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted);">
                                <th style="padding: 15px; font-weight: 500;">회차</th>
                                <th style="padding: 15px; font-weight: 500;">일시</th>
                                <th style="padding: 15px; font-weight: 500;">나의 제안 (만)</th>
                                <th style="padding: 15px; font-weight: 500;">분석 결과</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="4" style="padding: 30px; text-align: center; color: var(--text-muted);">
                                    아직 제안 내역이 없습니다.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Proposal History State
        let proposalHistory = [];
        let proposalCount = 0;
        const MAX_PROPOSALS = 3;

        // Position Selection
        let currentPosition = 'payer'; // Default: Paying

        function selectPosition(type) {
            currentPosition = type;
            const payerBtn = document.getElementById('pos-payer');
            const receiverBtn = document.getElementById('pos-receiver');
            const guideText = document.getElementById('amountGuideText');

            // Reset styles
            [payerBtn, receiverBtn].forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'rgba(255, 255, 255, 0.05)';
                btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                btn.style.color = '#888';
                btn.style.boxShadow = 'none';
            });

            // Activate specific button
            const targetBtn = type === 'payer' ? payerBtn : receiverBtn;
            targetBtn.classList.add('active');
            targetBtn.style.background = 'rgba(59, 130, 246, 0.2)';
            targetBtn.style.borderColor = '#3b82f6';
            targetBtn.style.color = '#fff';
            targetBtn.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.2)';

            // Update Text
            if (type === 'payer') {
                guideText.textContent = "상대방에게 지급할 금액을 입력하세요.";
            } else {
                guideText.textContent = "상대방에게 받고 싶은 금액을 입력하세요.";
            }
        }

        // Duration Selection
        let selectedDuration = 7; // default 1 week

        function selectDuration(days) {
            selectedDuration = days;
            // Update UI
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'rgba(255, 255, 255, 0.05)';
                btn.style.color = '#888';
                btn.style.border = '1px solid rgba(255,255,255,0.1)';
            });

            const activeBtn = document.getElementById(`btn-${days}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.background = '#4ade80';
                activeBtn.style.color = '#000';
                activeBtn.style.fontWeight = 'bold';
                activeBtn.style.border = '1px solid #4ade80';
                activeBtn.style.boxShadow = '0 0 10px rgba(74, 222, 128, 0.3)';
            }
        }

        // Mock function to simulate Blind Gap Logic - 5 Level System + Man-won Unit + Over-offer Check
        function submitProposal() {
            // 1. Check Limits
            if (proposalCount >= MAX_PROPOSALS) {
                return alert('제안 횟수(3회)를 모두 소진했습니다. 더 이상 수정 제안할 수 없습니다.');
            }

            const rawInput = parseInt(document.getElementById('myAmount').value);
            if (!rawInput) return alert('희망 금액을 입력해주세요.');

            // Confirm
            const positionText = currentPosition === 'payer' ? '지급' : '수령';
            if (!confirm(`[남은 제안 횟수: ${MAX_PROPOSALS - proposalCount - 1}회]\n\n${rawInput}만원을 '${positionText}'하는 조건으로 제안하시겠습니까?\n(유효기간: ${selectedDuration}일)\n제안 즉시 상대방에게 알림이 발송됩니다.`)) return;


            // Convert Man-won to Won
            const myAmount = rawInput * 10000;

            const btn = document.querySelector('.btn-primary');
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 분석 및 전송중...';
            btn.disabled = true;

            setTimeout(() => {
                // Scenario: Mock Opponent Data (Testing Mode)
                // TODO: Replace this with real DB data in production.
                const opponent = {
                    role: 'receiver', // 'payer' or 'receiver'
                    amount: 8000000   // 800 Man-won
                };

                // 2. Logic: Check for Role Conflict
                if (currentPosition === opponent.role) {
                    // ERROR: Both want to give OR Both want to receive
                    document.getElementById('waitingState').style.display = 'none';
                    document.getElementById('resultState').style.display = 'block';

                    const gapTitle = document.getElementById('gapTitle');
                    const gapDesc = document.getElementById('gapDesc');
                    const gapGauge = document.getElementById('gapGauge');
                    const statusBadge = document.getElementById('statusBadge');
                    const actionButtons = document.getElementById('actionButtons');

                    gapTitle.innerHTML = "⚠️ 입장이 충돌합니다";
                    gapDesc.innerHTML = `양측 모두 <strong>'${currentPosition === 'payer' ? '돈을 주겠다' : '돈을 받겠다'}'</strong>고 선택했습니다.<br>서로의 의사가 엇갈립니다. 상대방과 역할을 다시 확인해주세요.`;

                    gapGauge.style.width = '100%';
                    gapGauge.style.background = '#666'; // Grey for error
                    gapGauge.style.boxShadow = 'none';

                    statusBadge.textContent = '역할 충돌';
                    statusBadge.style.color = '#ccc';
                    statusBadge.style.border = '1px solid #ccc';

                    // Clear Range Hint if exists
                    const rangeElement = document.getElementById('rangeHintBox');
                    if (rangeElement) rangeElement.style.display = 'none';

                    actionButtons.innerHTML = '<button class="btn btn-primary" onclick="location.reload()">다시 선택하기</button>';

                    btn.innerHTML = originalBtnText;
                    btn.disabled = false;
                    return; // Stop processing
                }

                // 3. Logic: Check for Deal Success (Over-Offer / Good Deal)
                let isDealSuccess = false;

                if (currentPosition === 'payer') {
                    // I am paying. If I offer MORE than they want, it's a deal.
                    if (myAmount >= opponent.amount) isDealSuccess = true;
                } else {
                    // I am receiving. If I ask for LESS than they offer, it's a deal.
                    // Note: In this mock, opponent is 'receiver', so we won't hit this unless we change mock data.
                    // But if opponent was 'payer' (offering 800), and I ask for 700, indeed deal.
                    if (myAmount <= opponent.amount) isDealSuccess = true;
                }

                const diff = Math.abs(opponent.amount - myAmount);
                const average = (opponent.amount + myAmount) / 2;
                let gapPercent = (diff / average) * 100;

                // Exception for small amounts
                if (diff <= 500000) gapPercent = 0;

                // Forced Level 1 if Deal Success (Over-offer / Under-ask)
                if (isDealSuccess) {
                    gapPercent = 0; // Force to 0% gap logic
                }

                // Show Result
                document.getElementById('waitingState').style.display = 'none';
                document.getElementById('resultState').style.display = 'block';

                const gapTitle = document.getElementById('gapTitle');
                const gapDesc = document.getElementById('gapDesc');
                const gapGauge = document.getElementById('gapGauge');

                // Reset Range Hint Display
                let rangeElement = document.getElementById('rangeHintBox');
                if (rangeElement) rangeElement.style.display = 'block';

                const statusBadge = document.getElementById('statusBadge');
                const actionButtons = document.getElementById('actionButtons');

                // Determine Level (Re-using existing vars)
                let level = 0;
                let color = '';
                let title = '';
                let desc = '';
                let width = '';
                let badgeText = '';

                if (gapPercent <= 10) {
                    // Level 1: Green Zone (Including Over-offer)
                    level = 1;
                    color = '#4ade80'; // Green

                    // Calculate Average (Final Settlement Amount)
                    const finalAmount = Math.round((myAmount + opponent.amount) / 2 / 10000) * 10000;

                    // Blind Proposal Content
                    title = "축하합니다! 의견이 거의 일치합니다";
                    desc = `양측의 제안 금액 차이가 <strong>10% 이내</strong>입니다.<br>구체적인 금액을 확인하기 전에, <strong>두 제안의 평균값</strong>으로 합의를 확정하시겠습니까?`;

                    if (isDealSuccess) {
                        desc = `제안하신 조건이 상대방의 기대치를 충분히 충족합니다.<br><strong>두 제안의 평균값</strong>으로 합의를 확정하시겠습니까?`;
                    }

                    width = '98%'; // Max full
                    badgeText = '성사 확실';

                    // Special Action for Blind Consent
                    // We render a special "Consent View" instead of the standard Result View initially
                    // However, to keep it simple within this structure, we use the ActionButton to trigger the reveal.

                    // Hide the Gauge and Range Hint initially for this specific case to maintain "Blindness"
                    gapGauge.style.display = 'none';
                    if (rangeElement) rangeElement.style.display = 'none';

                    // Add a special customized visual for "Locked Agreement"
                    let hiddenBox = document.getElementById('hiddenAgreementBox');
                    if (!hiddenBox) {
                        hiddenBox = document.createElement('div');
                        hiddenBox.id = 'hiddenAgreementBox';
                        hiddenBox.style.margin = '20px 0';
                        hiddenBox.style.padding = '30px';
                        hiddenBox.style.border = '2px dashed #4ade80';
                        hiddenBox.style.borderRadius = '12px';
                        hiddenBox.style.backgroundColor = 'rgba(74, 222, 128, 0.05)';
                        hiddenBox.innerHTML = `
                            <div style="font-size: 3rem; margin-bottom: 15px;">🤝</div>
                            <div style="font-size: 1.1rem; font-weight: bold; color: #4ade80; margin-bottom: 5px;">히든 합의 제안</div>
                            <div style="font-size: 0.9rem; color: #aaa;">평균값 규칙 적용</div>
                        `;
                        // Insert after title/desc
                        document.getElementById('resultState').insertBefore(hiddenBox, actionButtons);
                    }
                    hiddenBox.style.display = 'block';

                    actionButtons.innerHTML = `<button class="btn btn-primary" onclick="confirmSettlement(${finalAmount}, ${myAmount}, ${opponent.amount})" style="background: #4ade80; color: #000; font-weight:bold;">평균값으로 합의 동의 및 확정</button>`;

                } else if (gapPercent <= 30) {
                    // Level 2: Blue Zone
                    level = 2;
                    color = '#3b82f6'; // Blue
                    title = "긍정적인 조율 단계입니다";
                    desc = `서로의 의견 차이가 <strong>크지 않습니다.</strong><br>안심 채팅을 통해 구체적인 사정을 설명하면 충분히 간격을 좁힐 수 있습니다.`;
                    width = '75%';
                    badgeText = '조율 가능';
                    actionButtons.innerHTML = '<button class="btn btn-glass" style="margin-right: 10px;" onclick="resetForNewProposal()">수정 제안하기</button><button class="btn btn-primary">안심 채팅방 열기</button>';
                } else if (gapPercent <= 60) {
                    // Level 3: Yellow Zone
                    level = 3;
                    color = '#facc15'; // Yellow
                    title = "희망 금액의 차이가 큽니다";
                    desc = `상대방과는 생각의 차이가 존재합니다.<br>조금 더 신중하게 고민해보시거나, 시간을 두고 <strong>수정 제안</strong>을 해보시기 바랍니다.`;
                    width = '50%';
                    badgeText = '차이 발생';
                    actionButtons.innerHTML = '<button class="btn btn-primary" style="background: #facc15; color: #000;" onclick="resetForNewProposal()">수정 제안하기</button>';
                } else if (gapPercent <= 100) {
                    // Level 4: Orange Zone
                    level = 4;
                    color = '#fb923c'; // Orange
                    title = "입장 차이가 매우 큽니다";
                    desc = `현재 상태로는 합의가 어렵습니다. 상대방은 그와는 <strong>전혀 다른 기준</strong>을 가지고 있습니다.<br>잠시 냉각기를 가지는 것을 추천합니다.`;
                    width = '25%';
                    badgeText = '큰 격차';
                    actionButtons.innerHTML = '<button class="btn btn-glass" onclick="resetForNewProposal()">제안 보류하기</button><button class="btn btn-primary" style="margin-left: 10px;" onclick="resetForNewProposal()">다시 제안하기</button>';
                } else {
                    // Level 5: Red Zone
                    level = 5;
                    color = '#ef4444'; // Red
                    title = "합의가 도출이 어려워 보입니다";
                    desc = `간격이 너무 큽니다 (100% 이상 차이).<br>사실상 결렬 상태입니다. 형사 조정 절차나 정식 재판을 준비하시는 것이 효율적입니다.`;
                    width = '10%';
                    badgeText = '결렬 위기';
                    actionButtons.innerHTML = '<button class="btn btn-primary" style="background: #ef4444;">형사 절차 안내 보기</button>';
                }

                // Update UI Elements
                gapTitle.innerHTML = title; // Use innerHTML for HTML content
                gapDesc.innerHTML = desc;

                // Animate Gauge
                gapGauge.style.width = width;
                gapGauge.style.background = color;
                gapGauge.style.boxShadow = `0 0 20px ${color}`;

                statusBadge.textContent = badgeText;
                statusBadge.style.color = color;
                statusBadge.style.background = 'rgba(255,255,255,0.05)';
                statusBadge.style.border = `1px solid ${color}`;

                // Add Range Hint (Blurring Effect) - Only shown if NOT Valid Error
                const minRange = Math.floor(opponent.amount * 0.8 / 10000) * 10000;
                const maxRange = Math.ceil(opponent.amount * 1.2 / 10000) * 10000;

                let rangeElementInner = document.getElementById('rangeHintBox');
                if (!rangeElementInner) {
                    rangeElementInner = document.createElement('div');
                    rangeElementInner.id = 'rangeHintBox';
                    rangeElementInner.style.marginTop = '20px';
                    rangeElementInner.style.padding = '15px';
                    rangeElementInner.style.background = 'rgba(255,255,255,0.05)';
                    rangeElementInner.style.borderRadius = '8px';
                    document.getElementById('resultState').insertBefore(rangeElementInner, actionButtons);
                }
                rangeElementInner.style.display = 'block';

                rangeElementInner.innerHTML = `
                    <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">상대방 제안 예상 범위</div>
                    <div style="font-size: 1.2rem; font-weight: bold; color: #fff; filter: blur(${level >= 4 ? '5px' : '0px'}); transition: filter 0.5s;">
                        ${minRange.toLocaleString()}원 ~ ${maxRange.toLocaleString()}원
                    </div>
                     ${level >= 4 ? '<div style="font-size:0.7rem; color:#ef4444; margin-top:5px;">격차가 너무 커서 범위조차 흐릿합니다.</div>' : ''}
                `;

                // Add to History
                proposalCount++;
                const now = new Date();
                const timeString = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

                const historyItem = {
                    round: proposalCount,
                    time: timeString,
                    amount: myAmount,
                    result: badgeText,
                    color: color
                };

                proposalHistory.unshift(historyItem);
                updateHistoryUI();
                updateCountUI();

                btn.innerHTML = originalBtnText; // Reset button text for next time if allowed

                if (proposalCount >= MAX_PROPOSALS) {
                    btn.textContent = '제안 횟수 초과';
                    btn.disabled = true;
                } else {
                    btn.disabled = false;
                }

            }, 1000); // Slightly realistic delay
        }

        // Reveal Function for Level 1 Success
        function confirmSettlement(finalAmount, myAmount, opponentAmount) {
            // Remove the hidden box
            const hiddenBox = document.getElementById('hiddenAgreementBox');
            if (hiddenBox) hiddenBox.style.display = 'none';

            // Update Title & Desc with REAL numbers
            const gapTitle = document.getElementById('gapTitle');
            const gapDesc = document.getElementById('gapDesc');

            gapTitle.innerHTML = `<span style="color:#4ade80">최종 합의금 ${finalAmount.toLocaleString()}원</span>`;
            gapDesc.innerHTML = `
                축하합니다! 합의가 확정되었습니다.<br>
                <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="color:#aaa;">나의 제안</span>
                        <span>${myAmount.toLocaleString()}원</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">
                        <span style="color:#aaa;">상대방 제안</span>
                        <span>${opponentAmount.toLocaleString()}원</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold; color:#4ade80; margin-top:5px;">
                        <span>최종 결정 (평균)</span>
                        <span>${finalAmount.toLocaleString()}원</span>
                    </div>
                </div>
            `;

            // Change Action Buttons to Next Step
            // Change Action Buttons to Next Step
            const actionButtons = document.getElementById('actionButtons');
            actionButtons.innerHTML = `<button class="btn btn-primary" onclick="goToAccountPage()">합의금 지급/수령으로 이동하기 <i class="fas fa-arrow-right"></i></button>`;

            // Trigger Confetti or Sound effect here if available
        }

        function resetForNewProposal() {
            if (proposalCount >= MAX_PROPOSALS) return alert("제안 횟수를 모두 소진했습니다.");
            // Optional: Reset view to let them try again if they want to modify
            // For this flow, we might just keep the result and let them change input on the left
            location.reload(); // Simple reload for demo
        }

        function updateHistoryUI() {
            const tbody = document.getElementById('historyTableBody');
            if (proposalHistory.length === 0) return;

            tbody.innerHTML = proposalHistory.map(item => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 15px;">${item.round}차</td>
                    <td style="padding: 15px; color: var(--text-muted); font-size: 0.9rem;">${item.time}</td>
                    <td style="padding: 15px; font-weight: bold;">${item.amount.toLocaleString()}</td>
                    <td style="padding: 15px;">
                        <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; border: 1px solid ${item.color}; color: ${item.color}; background: rgba(255,255,255,0.05);">
                            ${item.result}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function updateCountUI() {
            // document.getElementById('currentCount').textContent = proposalCount; // Removed: Element not found
            const leftCountEl = document.getElementById('leftCount');
            if (leftCountEl) leftCountEl.textContent = MAX_PROPOSALS - proposalCount;
        }

        // Navigation Helper
        function goToAccountPage() {
            // Set the active tab for case_detail.js to pick up
            localStorage.setItem('active_tab_on_load', 'account');
            location.href = 'case_detail.html';
        }

        // Initialize
        updateCountUI();
    </script>
</body>

</html>