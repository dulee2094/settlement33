<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블라인드 합의 제안 - SafeHappE</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/blind_proposal.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Midpoint Agreement Functions -->
    <script src="midpoint_agreement.js"></script>
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar - Focus Mode -->
        <aside class="sidebar">
            <a href="index.html" class="logo">
                <div class="logo-grid">
                    <span class="logo-row-en logo-en-left">Safe</span>
                    <span class="logo-row-en logo-en-right">HappE.</span>
                    <span class="logo-row-kr logo-kr-left">세이프</span>
                    <span class="logo-row-kr logo-kr-right">합의</span>
                </div>
            </a>

            <!-- Context Info -->
            <div
                style="padding: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">현재 조율 중인 사건</div>
                <div id="sidebarCaseNumber"
                    style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 5px;">-</div>
                <div style="font-size: 0.85rem; color: #aaa;"><i class="fas fa-user"></i> 상대방: <span
                        id="sidebarCounterparty">-</span></div>
            </div>

            <nav class="nav-links">
                <div class="nav-item active"
                    style="margin-bottom: 30px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                    <i class="fas fa-search-dollar"></i>
                    <span>블라인드 제안 중</span>
                </div>

                <div class="nav-item" onclick="location.href='case_detail.html'"
                    style="cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">
                    <i class="fas fa-arrow-left"></i>
                    <span>사건 상세 현황으로 복귀</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <h2 style="margin-bottom: 5px;">블라인드 합의 제안</h2>
                    <p style="color: var(--text-muted);">감정 소모 없이 희망 금액을 조율해보세요.</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-glass" style="font-size: 0.85rem;" onclick="location.href='dashboard.html'">
                        <i class="fas fa-arrow-left" style="margin-right: 6px;"></i> 뒤로가기
                    </button>
                    <span class="status-badge" id="statusBadge"
                        style="background: var(--bg-card); color: var(--text-muted);">제안 대기중</span>
                </div>
            </div>

            <!-- Blind Proposal Section -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                <!-- Left Column: Input Form -->
                <div class="glass-card" id="myProposalCard">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-edit" style="color: #3b82f6;"></i> 나의 제안 등록
                    </h3>

                    <!-- Convergence Guide -->
                    <div
                        style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #fbbf24;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> <strong>주의
                            (Irreversible)</strong><br>
                        한 번 제안한 금액은 되돌릴 수 없으며, 다음 차수 제안 시 <strong>"합의 수렴 원칙"</strong>에 따라 본인에게 더 유리한 금액(지급액 축소/수령액 증액)으로
                        변경할 수 없습니다. 신중하게 제안해주세요.
                    </div>

                    <div
                        style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <!-- Position Toggle -->
                        <div
                            style="display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px;">
                            <button id="pos-payer" onclick="selectPosition('payer')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(59, 130, 246, 0.2); color: white; border-color: #3b82f6; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-usd"></i> 지급 (주겠습니다)
                            </button>
                            <button id="pos-receiver" onclick="selectPosition('receiver')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255,255,255,0.05); color: #888; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-heart"></i> 수령 (받겠습니다)
                            </button>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">합의
                                희망 금액 (만원)</label>
                            <div style="position: relative;">
                                <input type="number" id="myAmount" placeholder="예: 500"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; color: white; font-size: 1.1rem; padding-right: 50px;">
                                <span
                                    style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #888;">만원</span>
                            </div>
                            <p id="amountGuideText" style="font-size: 0.8rem; color: #888; margin-top: 8px;">
                                상대방에게 지급할 금액을 입력하세요.
                            </p>
                        </div>

                        <!-- Duration -->
                        <div style="margin-bottom: 20px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">제안
                                유효 기간</label>
                            <div style="display: flex; gap: 8px;">
                                <div class="duration-btn" id="btn-0.25" onclick="selectDuration(0.25)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    6시간</div>
                                <div class="duration-btn active" id="btn-1" onclick="selectDuration(1)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #4ade80; background: #4ade80; color: #000; font-weight: bold; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">
                                    1일</div>
                                <div class="duration-btn" id="btn-3" onclick="selectDuration(3)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    3일</div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="submitProposal()"
                            style="width: 100%; padding: 15px; font-size: 1rem;">
                            제안 등록하기
                        </button>
                        <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #888;">
                            남은 제안 횟수: <span id="leftCount" style="color: #4ade80; font-weight: bold;">?</span>회
                        </div>
                    </div>

                    <!-- History -->
                    <div>
                        <h4 style="margin-bottom: 15px; font-size: 1rem; color: #cbd5e1;">나의 제안 이력</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); text-align: left;">
                                    <th style="padding: 10px;">차수</th>
                                    <th style="padding: 10px;">일시</th>
                                    <th style="padding: 10px;">금액(원)</th>
                                    <th style="padding: 10px;">결과</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Column: Dynamic Status Panel -->
                <div class="glass-card"
                    style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 480px;">

                    <!-- Priority 1: Midpoint Agreement Notification (Highest) -->
                    <div id="midpointResultArea"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;"></div>

                    <!-- Priority 2: Opponent Proposed Notification (NEW - Moved from Top) -->
                    <div id="opponentProposedNotification"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <!-- Priority 3: Extension Request Notification -->
                    <div id="extensionNotification"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <!-- Priority 4.2: Midpoint Agreement (Blind Consent) -->
                    <div id="midpointAgreementState"
                        style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                            ⚖️
                        </div>
                        <h3 style="color: #fff; margin-bottom: 15px;">합의 가능 구간(10%) 진입!</h3>
                        <div
                            style="background: rgba(251, 191, 36, 0.1); border: 1px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <p style="color: #fca5a5; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-lock"></i> 금액 비공개
                            </p>
                            <p style="color: #cbd5e1; line-height: 1.6; margin: 0;">
                                양측의 제안 차이가 <strong>10% 이내</strong>로 좁혀졌습니다.<br>
                                두 금액의 <strong>[정확한 중간값]</strong>으로<br>
                                합의금을 확정하시겠습니까?
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="btnRejectMidpoint" class="btn btn-glass"
                                style="flex: 1; border: 1px solid rgba(255,100,100,0.3); color: #fca5a5;">
                                아니오<br><span style="font-size: 0.8rem;">협상 계속</span>
                            </button>
                            <button id="btnAgreeMidpoint" class="btn btn-primary"
                                style="flex: 1.5; background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);">
                                네, 동의합니다<br><span style="font-size: 0.8rem;">즉시 타결</span>
                            </button>
                        </div>
                        <p style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">
                            * 양측 모두 동의 시 합의가 성립되며 금액이 공개됩니다.
                        </p>
                    </div>

                    <!-- Priority 4.5: Analysis Confirmation (Two-Step Verification) -->
                    <div id="analysisReadyState" style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                            🎉
                        </div>
                        <h3 style="color: #fff; margin-bottom: 15px;">1라운드 분석 완료!</h3>
                        <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 30px;">
                            양측의 제안이 모두 등록되어<br>
                            AI 격차 분석이 완료되었습니다.<br>
                            결과를 확인하시겠습니까?
                        </p>
                        <button class="btn btn-primary" onclick="viewAnalysisResult()"
                            style="width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 50px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="fas fa-search-dollar" style="margin-right: 10px;"></i> 분석 결과 확인하기
                        </button>
                        <p style="margin-top: 15px; font-size: 0.8rem; color: #64748b;">
                            * 결과를 확인하면 1라운드가 종료됩니다.
                        </p>
                    </div>

                    <!-- Priority 5: Result Analysis State (Graph) -->
                    <div id="resultState" style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <!-- Round End Badge -->
                        <div
                            style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 15px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            🛑 1라운드 종료
                        </div>

                        <div id="gapTitle"
                            style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #fff;"></div>
                        <div id="gapDesc" style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem;">
                        </div>

                        <!-- Gauge Visual -->
                        <div
                            style="width: 100%; max-width: 300px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin: 0 auto 30px auto; position: relative; overflow: hidden;">
                            <div id="gapGauge"
                                style="height: 100%; width: 0%; background: #4ade80; border-radius: 5px; transition: width 1s ease;">
                            </div>
                        </div>

                        <!-- Info Grid -->
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; text-align: left;">
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">나의 제안</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;" id="myCurrentDisplay">-
                                </div>
                            </div>
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;"
                                id="rangeHintBox">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">금액 차이(Gap)</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;">분석 중...</div>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 15px; color: #fff; font-size: 1rem;">SafeHappE AI 조언</h4>
                        <div
                            style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #3b82f6; text-align: left; font-size: 0.9rem; color: #cbd5e1; line-height: 1.6;">
                            현재 격차를 줄이기 위해서는 상대방의 입장을 고려한 조금 더 유연한 제안이 필요할 수 있습니다. <br>
                            만약 격차가 10% 이내라면, <strong>중간 지점</strong>에서의 합의를 강력히 권장합니다.
                        </div>

                        <!-- Proceed to Next Round Button -->
                        <button class="btn btn-glass" onclick="confirmNextRound()"
                            style="width: 100%; margin-top: 20px; padding: 12px; font-size: 0.95rem; border: 1px solid rgba(255,255,255,0.2);">
                            <i class="fas fa-redo" style="margin-right: 8px;"></i> 2라운드 제안하러 가기
                        </button>
                    </div>

                    <!-- Priority 6: Default Waiting State -->
                    <div id="waitingState" style="display: block; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 20px; opacity: 0.3;">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <h3 style="color: var(--text-muted);">아직 제안을 등록하지 않았습니다</h3>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                            좌측에서 희망 금액을 입력하고<br>제안을 등록해주세요.
                        </p>
                    </div>
                </div>

                <!-- Core Logic Script -->
                <script src="js/blind_proposal.js"></script>
            </div>
        </main>

        <!-- Onboarding Guide Modal -->
        <div id="guideModal" class="guide-modal-overlay">
            <div class="guide-modal">
                <button class="guide-close-btn" onclick="closeGuide()">×</button>

                <div class="guide-slides-container">
                    <!-- Step 1: Blind Bidding -->
                    <div class="guide-slide active" data-step="1">
                        <div class="guide-icon">🙈</div>
                        <h3>서로의 금액은 보이지 않습니다</h3>
                        <p>상대방의 패를 보지 못한 채,<br>내가 생각하는 <strong>가장 합리적인 금액</strong>을 제안하세요.<br>상대방도 이 규칙에 동의하고 참여합니다.</p>
                        <div class="guide-tag">Blind System</div>
                    </div>

                    <!-- Step 2: Traffic Light -->
                    <div class="guide-slide" data-step="2">
                        <div class="guide-icon">🚦</div>
                        <h3>결과는 '색상'으로만 알려드립니다</h3>
                        <p>상대방이 제안한 금액과의 격차를<br><strong>신호등 색상</strong>으로 분석해드립니다.</p>
                        <div class="guide-traffic-example">
                            <span><i class="fas fa-circle" style="color:#4ade80"></i> 성사 확실</span>
                            <span><i class="fas fa-circle" style="color:#facc15"></i> 조율 필요</span>
                            <span><i class="fas fa-circle" style="color:#ef4444"></i> 격차 큼</span>
                        </div>
                    </div>

                    <!-- Step 3: Limit & Rules -->
                    <div class="guide-slide" data-step="3">
                        <div class="guide-icon">⚠️</div>
                        <h3>기회는 총 5번입니다</h3>
                        <p>한 번 제안한 금액은 <strong>되돌릴 수 없으며</strong>,<br>이전보다 불리한 금액으로 변경할 수 없습니다.<br>신중하게 제안해주세요.</p>
                        <div class="guide-tag">Irreversible</div>
                    </div>

                    <!-- Step 4: Settlement -->
                    <div class="guide-slide" data-step="4">
                        <div class="guide-icon">⚖️</div>
                        <h3>합리적인 '중간값' 합의</h3>
                        <p>양측의 제안 차이가 <strong>10% 이내</strong>로 좁혀지면,<br>AI가 공정한 <strong>[중간값]</strong>을 제시하여<br>즉시 타결을
                            도와드립니다.</p>
                        <div class="guide-tag">Auto-Settlement</div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="guide-footer">
                    <div class="guide-dots">
                        <span class="dot active"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                    <div class="guide-controls">
                        <button class="btn-text" onclick="skipGuide()" id="skipBtn">건너뛰기</button>
                        <button class="btn-next" onclick="nextSlide()" id="nextBtn">다음 <i
                                class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Do not show again -->
                <div class="guide-noshow">
                    <label>
                        <input type="checkbox" id="dontShowAgain"> 다시 보지 않기
                    </label>
                </div>
            </div>
        </div>


</html>