<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블라인드 합의 제안 - SafeHappE</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Midpoint Agreement Functions -->
    <script src="midpoint_agreement.js"></script>
    <style>
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
                border-color: rgba(59, 130, 246, 0.6);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
                border-color: rgba(59, 130, 246, 1);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
                border-color: rgba(59, 130, 246, 0.6);
            }
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
                transform: scale(1.02);
            }
        }

        @keyframes slide-in-right {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes bounce-icon {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr !important;
            }

            .glass-card {
                min-height: auto !important;
            }
        }
    </style>
</head>

<body>

    <div class="dashboard-layout">
        <!-- Sidebar - Focus Mode -->
        <aside class="sidebar">
            <a href="index.html" class="logo">
                <div class="logo-grid">
                    <span class="logo-row-en logo-en-left">Safe</span>
                    <span class="logo-row-en logo-en-right">HappE.</span>
                    <span class="logo-row-kr logo-kr-left">세이프</span>
                    <span class="logo-row-kr logo-kr-right">합의</span>
                </div>
            </a>

            <!-- Context Info -->
            <div
                style="padding: 20px; margin-bottom: 20px; background: rgba(255,255,255,0.05); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">현재 조율 중인 사건</div>
                <div id="sidebarCaseNumber"
                    style="font-weight: 700; font-size: 1.1rem; color: white; margin-bottom: 5px;">-</div>
                <div style="font-size: 0.85rem; color: #aaa;"><i class="fas fa-user"></i> 상대방: <span
                        id="sidebarCounterparty">-</span></div>
            </div>

            <nav class="nav-links">
                <div class="nav-item active"
                    style="margin-bottom: 30px; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                    <i class="fas fa-search-dollar"></i>
                    <span>블라인드 제안 중</span>
                </div>

                <div class="nav-item" onclick="location.href='case_detail.html'"
                    style="cursor: pointer; opacity: 0.8; transition: opacity 0.3s;">
                    <i class="fas fa-arrow-left"></i>
                    <span>사건 상세 현황으로 복귀</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <div>
                    <h2 style="margin-bottom: 5px;">블라인드 합의 제안</h2>
                    <p style="color: var(--text-muted);">감정 소모 없이 희망 금액을 조율해보세요.</p>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button class="btn btn-glass" style="font-size: 0.85rem;" onclick="location.href='dashboard.html'">
                        <i class="fas fa-arrow-left" style="margin-right: 6px;"></i> 뒤로가기
                    </button>
                    <span class="status-badge" id="statusBadge"
                        style="background: var(--bg-card); color: var(--text-muted);">제안 대기중</span>
                </div>
            </div>

            <!-- Blind Proposal Section -->
            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
                <!-- Left Column: Input Form -->
                <div class="glass-card" id="myProposalCard">
                    <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-edit" style="color: #3b82f6;"></i> 나의 제안 등록
                    </h3>

                    <!-- Convergence Guide -->
                    <div
                        style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; color: #fbbf24;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i> <strong>주의
                            (Irreversible)</strong><br>
                        한 번 제안한 금액은 되돌릴 수 없으며, 다음 차수 제안 시 <strong>"합의 수렴 원칙"</strong>에 따라 본인에게 더 유리한 금액(지급액 축소/수령액 증액)으로
                        변경할 수 없습니다. 신중하게 제안해주세요.
                    </div>

                    <div
                        style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <!-- Position Toggle -->
                        <div
                            style="display: flex; gap: 10px; margin-bottom: 20px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px;">
                            <button id="pos-payer" onclick="selectPosition('payer')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(59, 130, 246, 0.2); color: white; border-color: #3b82f6; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-usd"></i> 지급 (주겠습니다)
                            </button>
                            <button id="pos-receiver" onclick="selectPosition('receiver')"
                                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid transparent; background: rgba(255,255,255,0.05); color: #888; transition: all 0.3s; cursor: pointer;">
                                <i class="fas fa-hand-holding-heart"></i> 수령 (받겠습니다)
                            </button>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">합의
                                희망 금액 (만원)</label>
                            <div style="position: relative;">
                                <input type="number" id="myAmount" placeholder="예: 500"
                                    style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; color: white; font-size: 1.1rem; padding-right: 50px;">
                                <span
                                    style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: #888;">만원</span>
                            </div>
                            <p id="amountGuideText" style="font-size: 0.8rem; color: #888; margin-top: 8px;">
                                상대방에게 지급할 금액을 입력하세요.
                            </p>
                        </div>

                        <!-- Duration -->
                        <div style="margin-bottom: 20px;">
                            <label
                                style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 8px;">제안
                                유효 기간</label>
                            <div style="display: flex; gap: 8px;">
                                <div class="duration-btn" id="btn-0.25" onclick="selectDuration(0.25)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    6시간</div>
                                <div class="duration-btn active" id="btn-1" onclick="selectDuration(1)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid #4ade80; background: #4ade80; color: #000; font-weight: bold; box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);">
                                    1일</div> <!-- Default Active -->
                                <div class="duration-btn" id="btn-3" onclick="selectDuration(3)"
                                    style="padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #888;">
                                    3일</div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="submitProposal()"
                            style="width: 100%; padding: 15px; font-size: 1rem;">
                            제안 등록하기
                        </button>
                        <div style="text-align: center; margin-top: 15px; font-size: 0.85rem; color: #888;">
                            남은 제안 횟수: <span id="leftCount" style="color: #4ade80; font-weight: bold;">?</span>회
                        </div>
                    </div>

                    <!-- History -->
                    <div>
                        <h4 style="margin-bottom: 15px; font-size: 1rem; color: #cbd5e1;">나의 제안 이력</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr
                                    style="border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); text-align: left;">
                                    <th style="padding: 10px;">차수</th>
                                    <th style="padding: 10px;">일시</th>
                                    <th style="padding: 10px;">금액(원)</th>
                                    <th style="padding: 10px;">결과</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Dynamic Rows -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Column: Dynamic Status Panel -->
                <div class="glass-card"
                    style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; min-height: 480px;">

                    <!-- Priority 1: Midpoint Agreement Notification (Highest) -->
                    <div id="midpointResultArea"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;"></div>

                    <!-- Priority 2: Opponent Proposed Notification (NEW - Moved from Top) -->
                    <div id="opponentProposedNotification"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <!-- Priority 3: Extension Request Notification -->
                    <div id="extensionNotification"
                        style="display: none; width: 100%; animation: slide-in-right 0.5s ease-out;">
                        <!-- Dynamic content will be inserted here -->
                    </div>

                    <!-- Priority 4.2: Midpoint Agreement (Blind Consent) -->
                    <div id="midpointAgreementState"
                        style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                            ⚖️
                        </div>
                        <h3 style="color: #fff; margin-bottom: 15px;">합의 가능 구간(10%) 진입!</h3>
                        <div
                            style="background: rgba(251, 191, 36, 0.1); border: 1px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                            <p style="color: #fca5a5; font-weight: bold; margin-bottom: 10px;">
                                <i class="fas fa-lock"></i> 금액 비공개
                            </p>
                            <p style="color: #cbd5e1; line-height: 1.6; margin: 0;">
                                양측의 제안 차이가 <strong>10% 이내</strong>로 좁혀졌습니다.<br>
                                두 금액의 <strong>[정확한 중간값]</strong>으로<br>
                                합의금을 확정하시겠습니까?
                            </p>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="btnRejectMidpoint" class="btn btn-glass"
                                style="flex: 1; border: 1px solid rgba(255,100,100,0.3); color: #fca5a5;">
                                아니오<br><span style="font-size: 0.8rem;">협상 계속</span>
                            </button>
                            <button id="btnAgreeMidpoint" class="btn btn-primary"
                                style="flex: 1.5; background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);">
                                네, 동의합니다<br><span style="font-size: 0.8rem;">즉시 타결</span>
                            </button>
                        </div>
                        <p style="margin-top: 20px; font-size: 0.8rem; color: #64748b;">
                            * 양측 모두 동의 시 합의가 성립되며 금액이 공개됩니다.
                        </p>
                    </div>

                    <!-- Priority 4.5: Analysis Confirmation (Two-Step Verification) -->
                    <div id="analysisReadyState" style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                            🎉
                        </div>
                        <h3 style="color: #fff; margin-bottom: 15px;">1라운드 분석 완료!</h3>
                        <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 30px;">
                            양측의 제안이 모두 등록되어<br>
                            AI 격차 분석이 완료되었습니다.<br>
                            결과를 확인하시겠습니까?
                        </p>
                        <button class="btn btn-primary" onclick="viewAnalysisResult()"
                            style="width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 50px; box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); background: linear-gradient(135deg, #3b82f6, #2563eb);">
                            <i class="fas fa-search-dollar" style="margin-right: 10px;"></i> 분석 결과 확인하기
                        </button>
                        <p style="margin-top: 15px; font-size: 0.8rem; color: #64748b;">
                            * 결과를 확인하면 1라운드가 종료됩니다.
                        </p>
                    </div>

                    <!-- Priority 5: Result Analysis State (Graph) -->
                    <div id="resultState" style="display: none; width: 100%; animation: fade-in 0.5s ease-out;">
                        <!-- Round End Badge -->
                        <div
                            style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; margin-bottom: 15px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            🛑 1라운드 종료
                        </div>

                        <div id="gapTitle"
                            style="font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: #fff;"></div>
                        <div id="gapDesc" style="color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem;">
                        </div>

                        <!-- Gauge Visual -->
                        <div
                            style="width: 100%; max-width: 300px; height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin: 0 auto 30px auto; position: relative; overflow: hidden;">
                            <div id="gapGauge"
                                style="height: 100%; width: 0%; background: #4ade80; border-radius: 5px; transition: width 1s ease;">
                            </div>
                        </div>

                        <!-- Info Grid -->
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; text-align: left;">
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">나의 제안</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;" id="myCurrentDisplay">-
                                </div>
                            </div>
                            <div class="glass-card" style="background: rgba(255,255,255,0.03); padding: 15px;"
                                id="rangeHintBox">
                                <div style="font-size: 0.85rem; color: #aaa; margin-bottom: 5px;">금액 차이(Gap)</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #fff;">분석 중...</div>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 15px; color: #fff; font-size: 1rem;">SafeHappE AI 조언</h4>
                        <div
                            style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #3b82f6; text-align: left; font-size: 0.9rem; color: #cbd5e1; line-height: 1.6;">
                            현재 격차를 줄이기 위해서는 상대방의 입장을 고려한 조금 더 유연한 제안이 필요할 수 있습니다. <br>
                            만약 격차가 10% 이내라면, <strong>중간 지점</strong>에서의 합의를 강력히 권장합니다.
                        </div>

                        <!-- Proceed to Next Round Button -->
                        <button class="btn btn-glass" onclick="location.reload()"
                            style="width: 100%; margin-top: 20px; padding: 12px; font-size: 0.95rem; border: 1px solid rgba(255,255,255,0.2);">
                            <i class="fas fa-redo" style="margin-right: 8px;"></i> 2라운드 제안하러 가기
                        </button>
                    </div>

                    <!-- Priority 6: Default Waiting State -->
                    <div id="waitingState" style="display: block; animation: fade-in 0.5s ease-out;">
                        <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 20px; opacity: 0.3;">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <h3 style="color: var(--text-muted);">아직 제안을 등록하지 않았습니다</h3>
                        <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                            좌측에서 희망 금액을 입력하고<br>제안을 등록해주세요.
                        </p>
                    </div>
                </div>

                <script>
                    // Proposal History State
                    let proposalHistory = [];
                    let proposalCount = 0;
                    let maxLimit = 5; // Default Base

                    // Round State (NEW)
                    let currentRound = 1;
                    let myRound = 0;
                    let oppRound = 0;
                    let roundCompleted = false;
                    let previousRounds = [];
                    let currentRoundData = null;

                    // Result Viewing State (NEW - Phase 1)
                    let roundStatus = 'waiting'; // 'waiting', 'proposing', 'ready', 'completed'
                    let myResultViewed = false;
                    let oppResultViewed = false;
                    let analysisData = null;

                    // Extension State
                    let isExtended = false;
                    let iAgreedExtension = false;
                    let oppAgreedExtension = false;

                    // Midpoint Agreement State
                    let midpointProposed = false;
                    let midpointAmount = 0;
                    let iAgreedMidpoint = false;
                    let oppAgreedMidpoint = false;
                    let bothAgreedMidpoint = false;

                    // Position Selection
                    let currentPosition = 'payer'; // Default: Paying

                    // Initialize: Check Status from Server
                    document.addEventListener('DOMContentLoaded', async () => {
                        await initializePage();

                        // Polling for Opponent's Proposal & Midpoint Status
                        setInterval(async () => {
                            await checkStatusUpdate();
                        }, 5000); // Check every 5 seconds
                    });

                    // Helper function to hide all right panel states
                    function hideAllRightPanelStates() {
                        document.getElementById('midpointResultArea').style.display = 'none';
                        document.getElementById('opponentProposedNotification').style.display = 'none';
                        document.getElementById('extensionNotification').style.display = 'none';
                        document.getElementById('resultState').style.display = 'none';
                        document.getElementById('waitingState').style.display = 'none';
                    }

                    // Helper function to show specific state with animation
                    function showRightPanelState(stateId) {
                        hideAllRightPanelStates();
                        const element = document.getElementById(stateId);
                        if (element) {
                            element.style.display = 'block';
                        }
                    }

                    async function checkStatusUpdate() {
                        // Don't poll if already agreed or max limit reached (optimization)
                        if (proposalCount >= 5 && !isExtended) return;

                        const caseId = localStorage.getItem('current_case_id');
                        let userId = localStorage.getItem('user_id');

                        // Fallback for legacy user_info object
                        if (!userId) {
                            try {
                                const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
                                userId = userInfo.id;
                            } catch (e) { }
                        }
                        if (userId) userId = parseInt(userId, 10);
                        if (!caseId || !userId) return;

                        try {
                            const res = await fetch(`/api/case/proposal?caseId=${caseId}&userId=${userId}`);
                            const data = await res.json();

                            if (data.success) {
                                // Priority 1: Check for Midpoint Proposal (Highest Priority)
                                const midpointShown = await checkMidpointStatus();
                                if (midpointShown) return;

                                // Priority 2: Extension Request from Opponent
                                if (data.oppAgreedExtension && !data.iAgreed && !data.isExtended) {
                                    showRightPanelState('extensionNotification');
                                    document.getElementById('extensionNotification').innerHTML = `
                                        <div style="
                                            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.1));
                                            border: 2px solid #f59e0b;
                                            border-radius: 16px;
                                            padding: 30px;
                                            text-align: center;
                                            animation: pulse-glow 2s infinite;
                                        ">
                                            <div style="font-size: 3rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                                                🤝
                                            </div>
                                            <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.3rem;">
                                                상대방이 협상 연장을 요청했습니다
                                            </h3>
                                            <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 25px; font-size: 0.95rem;">
                                                이 제안을 수락하면 양측 모두<br>
                                                제안 기회가 <strong style="color: #fbbf24;">3회 추가</strong>됩니다.<br>
                                                아직 합의 가능성이 보인다면 연장에 동의해주세요.
                                            </p>
                                            <button class="btn btn-primary" onclick="requestExtension()" 
                                                style="background: #f59e0b; border:none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); padding: 12px 30px; font-size: 1rem;">
                                                <i class="fas fa-handshake" style="margin-right: 8px;"></i>
                                                연장 동의하기 (+3회)
                                            </button>
                                        </div>
                                    `;
                                    return;
                                }

                                // Priority 3: Opponent Proposed (Standard Blind Alert)
                                if (data.hasOpponentProposed && proposalCount === 0) {
                                    showRightPanelState('opponentProposedNotification');
                                    let expDateStr = "정보 없음";
                                    if (data.opponentLastProposal && data.opponentLastProposal.expiresAt) {
                                        const d = new Date(data.opponentLastProposal.expiresAt);
                                        expDateStr = d.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                                    }

                                    document.getElementById('opponentProposedNotification').innerHTML = `
                                        <div style="
                                            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.1));
                                            border: 2px solid #3b82f6;
                                            border-radius: 16px;
                                            padding: 30px;
                                            text-align: center;
                                            animation: pulse-glow 2s infinite;
                                        ">
                                            <div style="font-size: 3rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                                                🔔
                                            </div>
                                            <h3 style="color: #fff; margin-bottom: 10px; font-size: 1.3rem;">
                                                상대방이 제안을 등록했습니다!
                                            </h3>
                                            <div style="margin-bottom: 20px; font-size: 0.9rem; color: #fbbf24; font-weight: 600; background: rgba(251, 191, 36, 0.1); display: inline-block; padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.3);">
                                                <i class="fas fa-clock" style="margin-right: 5px;"></i> 유효기간: ${expDateStr} 까지
                                            </div>
                                            <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 20px; font-size: 0.95rem;">
                                                상대방은 기다리고 있습니다.<br>
                                                좌측에서 금액을 입력하면<br>
                                                <strong style="color: #60a5fa;">즉시 AI 격차 분석 결과</strong>를 확인할 수 있습니다.
                                            </p>
                                            <div style="
                                                background: rgba(0,0,0,0.3);
                                                padding: 12px 20px;
                                                border-radius: 25px;
                                                display: inline-block;
                                                font-size: 0.85rem;
                                                color: #94a3b8;
                                            ">
                                                <i class="fas fa-lock" style="margin-right: 5px;"></i> 상대방 금액 비공개 중
                                            </div>
                                        </div>
                                    `;
                                    return;
                                }
                            }
                        } catch (e) { console.error("Polling Error", e); }
                    }

                    async function initializePage() {
                        // --- 1. Session Check ---
                        const caseId = localStorage.getItem('current_case_id');
                        let userId = localStorage.getItem('user_id');

                        // Fallback for legacy user_info object if user_id not found
                        if (!userId) {
                            try {
                                const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
                                userId = userInfo.id;
                            } catch (e) { }
                        }

                        // Ensure userId is valid
                        if (userId) userId = parseInt(userId, 10);

                        // UI Binding
                        const caseNum = localStorage.getItem('current_case_number') || localStorage.getItem('current_case_title') || '-';
                        const counterParty = localStorage.getItem('current_counterparty') || '알 수 없음';

                        const elCase = document.getElementById('sidebarCaseNumber');
                        const elCounter = document.getElementById('sidebarCounterparty');
                        if (elCase) elCase.textContent = caseNum;
                        if (elCounter) elCounter.textContent = counterParty;

                        if (!caseId || !userId) {
                            alert("로그인 정보가 없거나 사건이 선택되지 않았습니다.");
                            location.href = 'dashboard.html';
                            return;
                        }

                        try {
                            const res = await fetch(`/api/case/proposal?caseId=${caseId}&userId=${userId}`);
                            const data = await res.json();

                            if (data.success) {
                                // 1. Update Extension State
                                isExtended = data.isExtended;
                                iAgreedExtension = data.iAgreed;
                                oppAgreedExtension = data.oppAgreed;

                                // Update Max Limit
                                maxLimit = isExtended ? 8 : 5;

                                // 2. Update Round State (NEW)
                                currentRound = data.currentRound || 1;
                                myRound = data.myRound || 0;
                                oppRound = data.oppRound || 0;
                                previousRounds = data.previousRounds || [];
                                currentRoundData = data.currentRoundData;

                                // Check if current round is completed
                                roundCompleted = currentRoundData && currentRoundData.completed;

                                // 3. Update Local State
                                proposalCount = data.myProposalCount;
                                if (data.myLastProposal) {
                                    window.myLastProposalAmount = data.myLastProposal.amount;
                                    if (data.myLastProposal.position) {
                                        selectPosition(data.myLastProposal.position);
                                    }
                                    // Store Expiration Time
                                    if (data.myLastProposal.expiresAt) {
                                        proposalExpiration = data.myLastProposal.expiresAt;
                                    }
                                }
                                updateCountUI();

                                // 4. Notification Logic - Use Right Panel States

                                // Check Midpoint Status First (Highest Priority)
                                const midpointShown = await checkMidpointStatus();

                                if (midpointShown) {
                                    // Already shown by checkMidpointStatus
                                }
                                // Priority 2: Show Round Completion (NEW!)
                                else if (roundCompleted && myRound === currentRound && oppRound === currentRound) {
                                    showRoundCompletionUI();
                                }
                                // Priority 3: Extension Request from Opponent (If I haven't agreed yet)
                                else if (oppAgreedExtension && !iAgreedExtension && !isExtended) {
                                    showRightPanelState('extensionNotification');
                                    document.getElementById('extensionNotification').innerHTML = `
                                        <div style="
                                            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.1));
                                            border: 2px solid #f59e0b;
                                            border-radius: 16px;
                                            padding: 30px;
                                            text-align: center;
                                            animation: pulse-glow 2s infinite;
                                        ">
                                            <div style="font-size: 3rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                                                🤝
                                            </div>
                                            <h3 style="color: #fff; margin-bottom: 15px; font-size: 1.3rem;">
                                                상대방이 협상 연장을 요청했습니다
                                            </h3>
                                            <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 25px; font-size: 0.95rem;">
                                                이 제안을 수락하면 양측 모두<br>
                                                제안 기회가 <strong style="color: #fbbf24;">3회 추가</strong>됩니다.<br>
                                                아직 합의 가능성이 보인다면 연장에 동의해주세요.
                                            </p>
                                            <button class="btn btn-primary" onclick="requestExtension()" 
                                                style="background: #f59e0b; border:none; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); padding: 12px 30px; font-size: 1rem;">
                                                <i class="fas fa-handshake" style="margin-right: 8px;"></i>
                                                연장 동의하기 (+3회)
                                            </button>
                                        </div>
                                    `;
                                }
                                // Priority 3: Opponent Proposed (Standard Blind Alert)
                                else if (data.hasOpponentProposed && proposalCount === 0) {
                                    showRightPanelState('opponentProposedNotification');
                                    let expDateStr = "정보 없음";
                                    if (data.opponentLastProposal && data.opponentLastProposal.expiresAt) {
                                        const d = new Date(data.opponentLastProposal.expiresAt);
                                        expDateStr = d.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                                    }

                                    document.getElementById('opponentProposedNotification').innerHTML = `
                                        <div style="
                                            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.1));
                                            border: 2px solid #3b82f6;
                                            border-radius: 16px;
                                            padding: 30px;
                                            text-align: center;
                                            animation: pulse-glow 2s infinite;
                                        ">
                                            <div style="font-size: 3rem; margin-bottom: 20px; animation: bounce-icon 2s infinite;">
                                                🔔
                                            </div>
                                            <h3 style="color: #fff; margin-bottom: 10px; font-size: 1.3rem;">
                                                상대방이 제안을 등록했습니다!
                                            </h3>
                                            <div style="margin-bottom: 20px; font-size: 0.9rem; color: #fbbf24; font-weight: 600; background: rgba(251, 191, 36, 0.1); display: inline-block; padding: 5px 12px; border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.3);">
                                                <i class="fas fa-clock" style="margin-right: 5px;"></i> 유효기간: ${expDateStr} 까지
                                            </div>
                                            <p style="color: #cbd5e1; line-height: 1.6; margin-bottom: 20px; font-size: 0.95rem;">
                                                상대방은 기다리고 있습니다.<br>
                                                좌측에서 금액을 입력하면<br>
                                                <strong style="color: #60a5fa;">즉시 AI 격차 분석 결과</strong>를 확인할 수 있습니다.
                                            </p>
                                            <div style="
                                                background: rgba(0,0,0,0.3);
                                                padding: 12px 20px;
                                                border-radius: 25px;
                                                display: inline-block;
                                                font-size: 0.85rem;
                                                color: #94a3b8;
                                            ">
                                                <i class="fas fa-lock" style="margin-right: 5px;"></i> 상대방 금액 비공개 중
                                            </div>
                                        </div>
                                    `;
                                }

                                // 4. Restore State
                                if (proposalCount > 0) {
                                    // Status Logic:
                                    // 1. If I viewed the result -> Show Result (Graph)
                                    // 2. If valid proposal pair exists but I haven't viewed -> Show Confirmation (Ready)
                                    // 3. Else -> Waiting

                                    if (data.myResultViewed) {
                                        // Show Result
                                        showRightPanelState('resultState');
                                        if (data.currentRoundData) {
                                            const d = data.currentRoundData;
                                            // If currentRoundData exists for THIS round
                                            const diff = d.diff;
                                            // We need my amount from history or current data
                                            const myAmount = window.myLastProposalAmount;
                                            const gapPercent = (diff / Math.max(d.offenderAmount, d.victimAmount)) * 100;

                                            showAnalysisResult(gapPercent, myAmount, diff);
                                        }
                                        // If not in currentRoundData (e.g. moved to next round?), use history? 
                                        // For simplicity, we trust currentRoundData returns the *latest relevant* data from API.

                                    } else if (data.roundStatus === 'ready') {
                                        // Both proposed, neither (or just me) hasn't viewed
                                        showRightPanelState('analysisReadyState');

                                    } else {
                                        // Waiting for opponent or analyzed failed
                                        // Standard Waiting Logic
                                        if (data.hasOpponentProposed) {
                                            if (data.myResultViewed) {
                                                // Should be covered by block #1, but fallback
                                                showRightPanelState('resultState');
                                            } else {
                                                // I proposed, Opponent proposed, but server didn't say 'ready'?
                                                // This implies round mismatch or something. 
                                                // But usually means 'waiting' if 'ready' logic in server is consistent.
                                                // If I haven't viewed, but opp proposed, server sends 'ready'.
                                                // If I viewed, server sends 'completed' or 'analyzed'.

                                                // Fallback: If hasOpponentProposed but not 'ready/analyzed', 
                                                // it means opponent proposed in DIFFERENT round? 
                                                // Or server logic is strictly 'ready' instantly.
                                                // Let's assume 'ready' covers it.

                                                // Display waiting just in case
                                                showRightPanelState('waitingState');
                                                document.getElementById('waitingState').innerHTML = `
                                                    <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
                                                    <h3>제안 등록 완료</h3>
                                                    <p style="color: var(--text-muted); margin-top: 10px;">상대방의 제안을 기다리는 중입니다...</p>
                                                    <div id="expirationTimerDisplay"></div>
                                                `;
                                                startExpirationTimer();
                                            }
                                        } else {
                                            // I proposed, Opponent hasn't
                                            showRightPanelState('waitingState');
                                            document.getElementById('waitingState').innerHTML = `
                                                <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
                                                <h3>제안 등록 완료</h3>
                                                <p style="color: var(--text-muted); margin-top: 10px;">상대방이 제안하면 분석 결과가 표시됩니다.</p>
                                                <div id="expirationTimerDisplay"></div>
                                            `;
                                            startExpirationTimer();
                                        }
                                    }
                                }
                            }
                        } catch (e) {
                            console.error("Init Error", e);
                        }
                    }

                    function selectPosition(type) {
                        currentPosition = type;
                        const payerBtn = document.getElementById('pos-payer');
                        const receiverBtn = document.getElementById('pos-receiver');
                        const guideText = document.getElementById('amountGuideText');

                        // Reset styles
                        [payerBtn, receiverBtn].forEach(btn => {
                            btn.classList.remove('active');
                            btn.style.background = 'rgba(255, 255, 255, 0.05)';
                            btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
                            btn.style.color = '#888';
                            btn.style.boxShadow = 'none';
                        });

                        // Activate specific button
                        const targetBtn = type === 'payer' ? payerBtn : receiverBtn;
                        targetBtn.classList.add('active');
                        targetBtn.style.background = 'rgba(59, 130, 246, 0.2)';
                        targetBtn.style.borderColor = '#3b82f6';
                        targetBtn.style.color = '#fff';
                        targetBtn.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.2)';

                        // Update Text
                        if (type === 'payer') {
                            guideText.textContent = "상대방에게 지급할 금액을 입력하세요.";
                        } else {
                            guideText.textContent = "상대방에게 받고 싶은 금액을 입력하세요.";
                        }
                    }

                    // Duration Selection
                    let selectedDuration = 1; // default 1 day

                    function selectDuration(days) {
                        selectedDuration = days;
                        // Update UI
                        document.querySelectorAll('.duration-btn').forEach(btn => {
                            btn.classList.remove('active');
                            btn.style.background = 'rgba(255, 255, 255, 0.05)';
                            btn.style.color = '#888';
                            btn.style.border = '1px solid rgba(255,255,255,0.1)';
                        });

                        const activeBtn = document.getElementById(`btn-${days}`);
                        if (activeBtn) {
                            activeBtn.classList.add('active');
                            activeBtn.style.background = '#4ade80';
                            activeBtn.style.color = '#000';
                            activeBtn.style.fontWeight = 'bold';
                            activeBtn.style.border = '1px solid #4ade80';
                            activeBtn.style.boxShadow = '0 0 10px rgba(74, 222, 128, 0.3)';
                        }
                    }



                    window.viewAnalysisResult = async () => {
                        const caseId = localStorage.getItem('current_case_id');
                        const userId = localStorage.getItem('user_id');

                        // Current round state comes from global `currentRound`
                        // But be careful, if opponent hasn't viewed, server says 'ready' but we want to confirm 'view'.

                        try {
                            const btn = document.querySelector('#analysisReadyState button');
                            const originalText = btn.innerHTML;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 확인 중...';
                            btn.disabled = true;

                            const res = await fetch('/api/case/proposal/view-result', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId, caseId, round: currentRound })
                            });
                            const data = await res.json();

                            if (data.success) {
                                const analysis = data.analysis;
                                // Priority 4.2: Midpoint Agreement Logic
                                if (analysis.midpointPossible && !analysis.midpointResolved) {
                                    showRightPanelState('midpointAgreementState');
                                    const btnAgree = document.getElementById('btnAgreeMidpoint');
                                    const btnReject = document.getElementById('btnRejectMidpoint');

                                    if (btnAgree) btnAgree.onclick = () => handleMidpointDecision(true);
                                    if (btnReject) btnReject.onclick = () => handleMidpointDecision(false);
                                    return;
                                }

                                // Update Local UI immediately
                                showRightPanelState('resultState');


                                const diff = analysis.diff;
                                const myAmt = analysis.myAmount;
                                const gapPercent = analysis.diffPercent;

                                showAnalysisResult(gapPercent, myAmt, diff);
                                addToHistory(myAmt, `R${currentRound} 완료`, '#4ade80', currentRound); // Helper needs update to accept round/color

                                // Reset round state logic locally to avoid flashing
                                roundStatus = 'completed';
                                myResultViewed = true;

                            } else {
                                alert('오류: ' + data.error);
                            }
                        } catch (e) {
                            console.error(e);
                            alert('통신 오류가 발생했습니다.');
                        }
                    };

                    // Add Midpoint Decision Handler
                    window.handleMidpointDecision = async (agreed) => {
                        const caseId = localStorage.getItem('current_case_id');
                        const userId = localStorage.getItem('user_id');

                        try {
                            if (agreed) {
                                if (!confirm("정말 동의하시겠습니까?\n\n양측이 모두 동의하면 즉시 '중간값'으로 합의가 체결되며, 금액이 공개됩니다.")) return;
                            } else {
                                if (!confirm("거절하시겠습니까?\n\n거절 시 현재 라운드가 종료되며, 다음 라운드(또는 최종 결렬)로 진행됩니다.")) return;
                            }

                            const res = await fetch('/api/case/proposal/midpoint-agreement', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId, caseId, round: currentRound, agreed })
                            });
                            const result = await res.json();

                            if (result.success) {
                                if (result.settled) {
                                    localStorage.setItem('final_agreed_amount', result.finalAmount);
                                    localStorage.setItem('current_case_status', 'settled');
                                    alert(`축하합니다! 합의가 성립되었습니다.\n\n최종 합의금: ${result.finalAmount.toLocaleString()}원\n\n[확인]을 누르면 합의서 작성 페이지로 이동합니다.`);
                                    location.href = 'agreement.html';
                                } else if (result.rejected) {
                                    alert("중간값 합의가 거절되었습니다. 2라운드를 진행합니다.");
                                    location.reload();
                                } else {
                                    alert("선택이 완료되었습니다. 상대방의 결정을 기다려주세요.");
                                    location.reload();
                                }
                            } else {
                                alert('오류: ' + result.error);
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    };

                    window.handleNextRoundAction = async () => {
                        // Check if we are at the limit (Round 5 or 8)
                        // Note: currentRound is updated from server. If we just finished Round 5, custom logic needed.

                        // We need global 'isExtended' to be accurate.
                        // Assuming maxLimit is handling it (5 or 8).

                        // Case 1: Normal rounds
                        if (currentRound < maxLimit) {
                            location.reload();
                            return;
                        }

                        // Case 2: Round 5 Finished, Not Extended
                        if (currentRound === 5 && !isExtended) {
                            if (confirm("정규 라운드(5회)가 모두 종료되었습니다.\n\n아직 합의에 이르지 못했다면, [협상 연장]을 요청하여\n3회의 추가 기회를 가질 수 있습니다.\n\n연장을 요청하시겠습니까?")) {
                                try {
                                    const caseId = localStorage.getItem('current_case_id');
                                    const userId = localStorage.getItem('user_id');
                                    const res = await fetch('/api/case/proposal/extend', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ caseId, userId })
                                    });
                                    const data = await res.json();
                                    if (data.success) {
                                        if (data.isExtended) {
                                            alert("양측 모두 동의하여 협상이 연장되었습니다! (총 8라운드)");
                                        } else {
                                            alert("연장 요청이 접수되었습니다.\n상대방도 동의하면 라운드가 추가됩니다.");
                                        }
                                        location.reload();
                                    } else {
                                        alert("오류: " + data.error);
                                    }
                                } catch (e) { console.error(e); }
                            } else {
                                // User rejected extension
                                alert("협상이 최종 결렬되었습니다.");
                                location.href = 'dashboard.html'; // Or relevant exit
                            }
                            return;
                        }

                        // Case 3: Round 8 Finished (Final)
                        if (currentRound >= 8) {
                            alert("최종 라운드(8회)까지 합의되지 않았습니다.\n협상이 결렬되었습니다.");
                            location.href = 'dashboard.html';
                            return;
                        }

                        // Fallback
                        location.reload();
                    };

                    window.submitProposal = async () => {
                        const rawInput = document.getElementById('myAmount').value.replace(/,/g, '');
                        if (!rawInput) return alert('희망 금액을 입력해주세요.');

                        // Global variable selectedDuration is updated by selectDuration()
                        if (!selectedDuration) return alert('제안 유효 기간을 선택해주세요.');

                        // Double check limit before sending (UI sync)
                        if (proposalCount >= maxLimit) {
                            // Check extension possibility again
                            if (proposalCount === 5 && !isExtended) {
                                if (confirm('기본 제안 횟수(5회)를 모두 소진했습니다.\n\n상대방에게 [협상 연장]을 요청하시겠습니까?\n(양측 동의 시 3회 추가)')) {
                                    requestExtension();
                                    return;
                                }
                                return;
                            } else {
                                return alert('제안 횟수를 모두 소진했습니다.');
                            }
                        }

                        const positionText = currentPosition === 'payer' ? '지급' : '수령';
                        const remaining = maxLimit - proposalCount - 1;
                        if (!confirm(`[남은 제안 횟수: ${remaining}회]\n\n${parseInt(rawInput).toLocaleString()}만원을 '${positionText}'하는 조건으로 제안하시겠습니까?\n한 번 제안하면 되돌릴 수 없습니다.`)) return;

                        const myAmount = rawInput * 10000;
                        const btn = document.querySelector('.btn-primary');
                        const originalBtnText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 분석 및 전송중...';
                        btn.disabled = true;


                        const caseId = localStorage.getItem('current_case_id');
                        let userId = localStorage.getItem('user_id');

                        // Fallback check
                        if (!userId) {
                            const userInfoStr = localStorage.getItem('user_info');
                            if (userInfoStr) {
                                try {
                                    const userInfo = JSON.parse(userInfoStr);
                                    if (userInfo.id) userId = userInfo.id;
                                } catch (e) { }
                            }
                        }

                        if (userId) userId = parseInt(userId, 10);

                        if (!caseId || !userId) {
                            alert("로그인 정보가 없거나 사건이 선택되지 않았습니다.\n초기화면으로 이동합니다.");
                            location.href = 'dashboard.html';
                            return;
                        }

                        console.log('Submitting proposal:', { caseId, userId, amount: myAmount });

                        // --- CONVERGENCE PRINCIPLE CHECK (Frontend) ---
                        // Check if previous proposal exists (Round 2+)
                        if (window.myLastProposalAmount && window.myLastProposalAmount > 0) {
                            const lastAmount = window.myLastProposalAmount;

                            // 1. Offender (Payer): Cannot propose LESS than before
                            if (currentPosition === 'payer' && myAmount < lastAmount) {
                                alert(`⛔ [합의 수렴 원칙 알림]\n\n이전 제안(${lastAmount.toLocaleString()}원)보다 낮은 금액을 제안할 수 없습니다.\n\n합의 가능성을 높이기 위해 이전 제안보다 같거나 높은 금액을 입력해주세요.`);
                                btn.innerHTML = originalBtnText;
                                btn.disabled = false;
                                return;
                            }

                            // 2. Victim (Receiver): Cannot propose MORE than before
                            // Note: 'receiver' logic assumes user wants to receive money.
                            if (currentPosition === 'receiver' && myAmount > lastAmount) {
                                alert(`⛔ [합의 수렴 원칙 알림]\n\n이전 제안(${lastAmount.toLocaleString()}원)보다 높은 금액을 제안할 수 없습니다.\n\n합의 가능성을 높이기 위해 이전 제안보다 같거나 낮은 금액을 입력해주세요.`);
                                btn.innerHTML = originalBtnText;
                                btn.disabled = false;
                                return;
                            }
                        }
                        // -----------------------------------------------

                        try {
                            const res = await fetch('/api/case/proposal', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ caseId, userId, amount: myAmount, duration: selectedDuration, position: currentPosition })
                            });
                            const data = await res.json();

                            if (!data.success) {
                                alert('오류 발생: ' + data.error);
                                btn.innerHTML = originalBtnText;
                                btn.disabled = false;
                                return;
                            }

                            // Check Midpoint Trigger
                            if (data.midpointTriggered) {
                                alert(`✨ 10% 이내 합의 제안!\n\n양측의 제안 금액이 10% 이내로 매우 가깝습니다!\n\n공정한 '중간 금액'(비공개)으로 합의하시겠습니까?\n[확인]을 누르면 동의 화면으로 이동합니다.`);
                                location.reload();
                                return;
                            }

                            // Increase Count
                            proposalCount++;
                            if (data.myLastProposal) {
                                window.myLastProposalAmount = myAmount;
                            } else {
                                window.myLastProposalAmount = myAmount;
                            }

                            updateCountUI();

                            if (data.status === 'waiting') {
                                showRightPanelState('waitingState');
                                document.getElementById('waitingState').innerHTML = `
                                    <div style="font-size: 4rem; color: #4ade80; margin-bottom: 20px;"><i class="fas fa-check-circle"></i></div>
                                    <h3>제안이 성공적으로 등록되었습니다</h3>
                                    <p style="color: var(--text-muted); margin-top: 10px;">상대방이 제안하면 분석 결과가 표시됩니다.</p>
                                    <button class="btn btn-glass" onclick="location.reload()" style="margin-top:20px;">새로고침</button>
                                `;
                                addToHistory(myAmount, '대기 중', '#888');

                            } else if (data.status === 'analyzed') {
                                const diff = data.data.diff;
                                let gapPercent = (diff / myAmount) * 100;
                                showAnalysisResult(gapPercent, myAmount, diff);
                                addToHistory(myAmount, '분석 완료', '#4ade80');
                            }

                        } catch (err) {
                            console.error(err);
                            alert('서버 통신 오류: ' + err.message);
                        } finally {
                            if (proposalCount < maxLimit) {
                                btn.innerHTML = originalBtnText;
                                btn.disabled = false;
                            } else {
                                updateCountUI();
                            }
                        }
                    }

                    function showAnalysisResult(gapPercent, myAmount, diff) {
                        showRightPanelState('resultState');

                        const gapTitle = document.getElementById('gapTitle');
                        const gapDesc = document.getElementById('gapDesc');
                        const gapGauge = document.getElementById('gapGauge');
                        const statusBadge = document.getElementById('statusBadge');

                        let color, title, desc, width, badgeText;

                        if (gapPercent <= 10) {
                            color = '#4ade80'; title = "축하합니다! 의견이 거의 일치합니다";
                            desc = "제안하신 금액과 상대방의 희망 금액 차이가 <strong>10% 이내</strong>입니다.";
                            width = '98%'; badgeText = "성사 확실";
                        } else if (gapPercent <= 30) {
                            color = '#3b82f6'; title = "긍정적인 조율 단계입니다";
                            desc = "의견 차이가 크지 않습니다. 조금만 더 조율하면 합의점을 찾을 수 있습니다.";
                            width = '75%'; badgeText = "조율 가능";
                        } else if (gapPercent <= 60) {
                            color = '#facc15'; title = "희망 금액의 차이가 큽니다";
                            desc = "생각의 차이가 존재합니다. 신중한 재고가 필요합니다.";
                            width = '50%'; badgeText = "차이 발생";
                        } else {
                            color = '#ef4444'; title = "입장 차이가 매우 큽니다";
                            desc = "상대방과 금액에 대한 기준이 많이 다릅니다.";
                            width = '25%'; badgeText = "큰 격차";
                        }

                        if (gapTitle) gapTitle.innerHTML = title;
                        if (gapDesc) gapDesc.innerHTML = desc;
                        if (gapGauge) {
                            gapGauge.style.width = width;
                            gapGauge.style.background = color;
                            gapGauge.style.boxShadow = `0 0 20px ${color}`;
                        }
                        if (statusBadge) {
                            statusBadge.textContent = badgeText;
                            statusBadge.style.color = color;
                            statusBadge.style.border = `1px solid ${color}`;
                        }
                    }

                    function addToHistory(amount, result, color, round) {
                        const now = new Date();
                        const timeString = `${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

                        // Use round if provided, otherwise fallback to proposalCount
                        // Note: proposalCount is 0-indexed in some contexts? No, it's 1-based count.
                        // But currentRound is better.
                        const rLabel = round ? round : (currentRound || proposalCount);

                        const historyItem = { round: rLabel, time: timeString, amount: amount, result: result, color: color };

                        // Check duplicate to avoid visual spam (if init called multiple times)
                        const exists = proposalHistory.some(h => h.round == rLabel && h.amount === amount);
                        if (!exists) {
                            proposalHistory.unshift(historyItem);
                        }

                        const tbody = document.getElementById('historyTableBody');
                        if (!tbody) return;

                        tbody.innerHTML = proposalHistory.map(item => `
                            <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <td style="padding: 15px;">R${item.round}</td>
                                <td style="padding: 15px; color: var(--text-muted); font-size: 0.9rem;">${item.time}</td>
                                <td style="padding: 15px; font-weight: bold;">${item.amount.toLocaleString()}</td>
                                <td style="padding: 15px;">
                                    <span style="font-size: 0.8rem; padding: 4px 10px; border-radius: 12px; border: 1px solid ${item.color}; color: ${item.color}; background: rgba(255,255,255,0.05);">
                                        ${item.result}
                                    </span>
                                </td>
                            </tr>
                        `).join('');
                    }

                    function updateCountUI() {
                        const leftCountEl = document.getElementById('leftCount');
                        if (leftCountEl) leftCountEl.textContent = Math.max(0, maxLimit - proposalCount);

                        const btn = document.querySelector('.btn-primary');
                        if (proposalCount >= maxLimit) {
                            // Check if extended
                            if (isExtended && proposalCount >= 8) {
                                btn.textContent = '최대 제안 횟수 초과 (종료)';
                                btn.disabled = true;
                                btn.onclick = null;
                            } else if (!isExtended && proposalCount >= 5) {
                                // Default Limit Reached -> Show Extension Option
                                if (iAgreedExtension) {
                                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 상대방 동의 대기중...';
                                    btn.disabled = true;
                                    btn.style.background = '#4b5563';
                                } else {
                                    btn.innerHTML = '<i class="fas fa-handshake"></i> 제안 횟수 연장 요청 (3회 추가)';
                                    btn.disabled = false;
                                    btn.onclick = requestExtension;
                                    btn.style.background = '#f59e0b';
                                    btn.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.4)';
                                }
                            } else {
                                // Regular limit reached (shouldn't happen if logic correct above)
                                btn.textContent = '제안 횟수 초과';
                                btn.disabled = true;
                            }
                        } else {
                            // Normal State
                            btn.textContent = '제안 등록하기';
                            btn.disabled = false;
                            btn.onclick = submitProposal;
                            btn.style.background = ''; // reset
                            btn.style.boxShadow = '';
                        }
                    }

                    async function requestExtension() {
                        if (!confirm("제안 횟수 연장을 요청하시겠습니까?\n\n상대방도 동의하면 총 제안 기회가 3회 추가됩니다.\n(상대방에게 알림이 발송됩니다)")) return;

                        const btn = document.querySelector('.btn-primary');
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 요청 중...';
                        btn.disabled = true;

                        try {
                            const caseId = localStorage.getItem('current_case_id');
                            const userInfo = JSON.parse(localStorage.getItem('user_info') || '{}');
                            const userId = userInfo.id;

                            const res = await fetch('/api/case/proposal/extend', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ caseId, userId })
                            });
                            const data = await res.json();

                            if (data.success) {
                                alert("연장 요청(또는 동의)이 완료되었습니다.\n상대방도 동의하면 즉시 횟수가 추가됩니다.");
                                location.reload();
                            } else {
                                alert("요청 실패: " + data.error);
                                location.reload();
                            }
                        } catch (e) {
                            console.error(e);
                            alert("오류 발생");
                        }
                    }

                    // Expiration Timer (NEW)
                    let proposalExpiration = null;
                    let timerInterval = null;

                    function startExpirationTimer() {
                        const timerEl = document.getElementById('expirationTimerDisplay');

                        // Clear existing timer
                        if (timerInterval) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                        }

                        // Exit if element doesn't exist or no expiration date
                        if (!timerEl || !proposalExpiration) return;

                        function update() {
                            const now = new Date().getTime();
                            const expireTime = new Date(proposalExpiration).getTime();
                            const diff = expireTime - now;

                            if (diff < 0) {
                                clearInterval(timerInterval);
                                timerEl.innerHTML = `
                                    <div style="background: rgba(239, 68, 68, 0.1); padding: 15px; border-radius: 10px; border: 1px solid #ef4444; margin-top: 20px;">
                                        <div style="color: #ef4444; font-weight: bold; margin-bottom: 5px;">⚠️ 제안 유효 시간이 만료되었습니다.</div>
                                        <div style="font-size: 0.85rem; color: #fca5a5;">상대방이 시간 내에 응답하지 않아<br>이 라운드는 종료되었습니다.</div>
                                        <button class="btn btn-sm" onclick="location.reload()" style="margin-top: 10px; background: #ef4444; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                                            상태 업데이트
                                        </button>
                                    </div>
                                `;
                                return;
                            }

                            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                            // Style based on remaining time
                            let timeColor = '#4ade80'; // Default Green
                            let containerStyle = 'background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);';
                            let icon = '';

                            if (diff < 1000 * 60 * 10) { // < 10 mins
                                timeColor = '#ef4444';
                                containerStyle = 'background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.5); animation: pulse-border 2s infinite;';
                                icon = '⚠️ ';
                            } else if (diff < 1000 * 60 * 60) { // < 1 hour
                                timeColor = '#f59e0b';
                                containerStyle = 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.5);';
                            }

                            timerEl.innerHTML = `
                                <div style="${containerStyle} padding: 15px; border-radius: 12px; margin-top: 20px;">
                                    <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 8px;">${icon}제안 유효 시간</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; color: ${timeColor}; font-family: monospace; letter-spacing: 2px; line-height: 1;">
                                        ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                                    </div>
                                    <div style="font-size: 0.75rem; color: #64748b; margin-top: 8px;">
                                        ${new Date(expireTime).toLocaleDateString()} ${new Date(expireTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} 만료
                                    </div>
                                </div>
                            `;
                        }

                        update();
                        timerInterval = setInterval(update, 1000);
                    }

                    function showRoundCompletionUI() {
                        showRightPanelState('resultState');

                        const resultState = document.getElementById('resultState');

                        // Build previous rounds history HTML
                        let historyHTML = '';
                        if (previousRounds.length > 0) {
                            historyHTML = `
                                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <h4 style="margin-bottom: 15px; color: #cbd5e1; font-size: 0.95rem;">이전 라운드 결과</h4>
                                    <div style="display: flex; flex-direction: column; gap: 10px;">
                                        ${previousRounds.map(r => {
                                if (r.completed) {
                                    return `
                                                    <div style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px; font-size: 0.85rem;">
                                                        <div style="color: #94a3b8; margin-bottom: 5px;">라운드 ${r.round}</div>
                                                        <div style="color: #fff;">차이: ${r.diff.toLocaleString()}원</div>
                                                    </div>
                                                `;
                                } else {
                                    return `
                                                    <div style="background: rgba(239, 68, 68, 0.1); padding: 12px; border-radius: 8px; font-size: 0.85rem; border: 1px solid rgba(239, 68, 68, 0.3);">
                                                        <div style="color: #fca5a5;">라운드 ${r.round}: 시간 만료</div>
                                                    </div>
                                                `;
                                }
                            }).join('')}
                                    </div>
                                </div>
                            `;
                        }

                        resultState.innerHTML = `
                            <div style="width: 100%;">
                                <div style="background: linear-gradient(135deg, rgba(74, 222, 128, 0.15), rgba(34, 197, 94, 0.1)); border: 2px solid #4ade80; border-radius: 16px; padding: 25px; margin-bottom: 20px;">
                                    <div style="font-size: 2.5rem; margin-bottom: 15px;">✅</div>
                                    <h3 style="color: #fff; margin-bottom: 10px; font-size: 1.3rem;">라운드 ${currentRound} 완료!</h3>
                                    <p style="color: #cbd5e1; font-size: 0.9rem;">양측의 제안이 모두 등록되었습니다.</p>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 15px; color: #fff;">라운드 ${currentRound} 분석 결과</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                                            <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px;">가해자 제안</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: #60a5fa;">${currentRoundData.offenderAmount.toLocaleString()}원</div>
                                        </div>
                                        <div style="background: rgba(168, 85, 247, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(168, 85, 247, 0.3);">
                                            <div style="font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px;">피해자 제안</div>
                                            <div style="font-size: 1.1rem; font-weight: bold; color: #c084fc;">${currentRoundData.victimAmount.toLocaleString()}원</div>
                                        </div>
                                    </div>
                                    <div style="background: rgba(251, 191, 36, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3); text-align: center;">
                                        <div style="font-size: 0.85rem; color: #fbbf24; margin-bottom: 5px;">금액 차이</div>
                                        <div style="font-size: 1.3rem; font-weight: bold; color: #fbbf24;">${currentRoundData.diff.toLocaleString()}원</div>
                                    </div>
                                </div>
                                
                                ${historyHTML}
                                
                                <button class="btn btn-primary" onclick="startNextRound()" style="width: 100%; padding: 15px; font-size: 1rem; margin-top: 20px;">
                                    <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>
                                    다음 라운드 시작 (라운드 ${currentRound + 1})
                                </button>
                            </div>
                        `;
                    }

                    // NEW: Start Next Round
                    function startNextRound() {
                        // Reset round completion flag
                        roundCompleted = false;

                        // Show waiting state for next round
                        showRightPanelState('waitingState');
                        document.getElementById('waitingState').innerHTML = `
                            <div style="font-size: 4rem; color: var(--text-muted); margin-bottom: 20px; opacity: 0.3;">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <h3 style="color: var(--text-muted);">라운드 ${currentRound + 1} 시작</h3>
                            <p style="color: #666; margin-top: 10px; font-size: 0.9rem;">
                                좌측에서 새로운 제안을 등록해주세요.
                            </p>
                        `;

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }

                    function resetForNewProposal() {
                        location.reload();
                    }
                </script>
            </div>
        </main>
    </div>
</body>

</html>