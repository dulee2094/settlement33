<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>합의 요청 - SafeSettlement</title>
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

    <div class="auth-container">
        <div class="auth-box glass-card" style="max-width: 800px; text-align: left;">
            <a href="dashboard.html"
                style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; display: inline-block;">
                <i class="fas fa-arrow-left"></i> 대시보드로 돌아가기
            </a>

            <h2 style="margin-bottom: 10px;">합의 요청 보내기</h2>
            <p style="color: var(--text-muted); margin-bottom: 30px;">
                상대방에게 플랫폼 접속 링크를 담은 알림 메시지를 발송합니다.<br>
                <span style="color: var(--secondary);">* 귀하의 연락처는 절대 노출되지 않으며, 'SafeSettlement' 이름으로 발송됩니다.</span>
            </p>

            <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr; gap: 40px;">
                <!-- Left: Input Form -->
                <div>
                    <div class="form-group">
                        <label class="form-label">사건 번호 또는 사건 명칭 (변경 가능)</label>
                        <input type="text" class="form-input" id="caseInfoInput" value="2024형제12345">
                        <small style="color: var(--text-muted); font-size: 0.8rem;">* 아직 사건 번호가 없다면 사건 명칭을
                            입력하세요.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">상대방 휴대폰 번호</label>
                        <input type="tel" class="form-input" placeholder="010-0000-0000" id="victimPhone">
                        <small style="color: var(--text-muted); font-size: 0.8rem;">* '-' 없이 입력하셔도 됩니다.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">보내는 사람 (표시될 이름)</label>
                        <input type="text" class="form-input" id="senderName" placeholder="실명 또는 닉네임 입력">
                    </div>

                    <div class="form-group">
                        <label class="form-label">추가 메시지 (선택)</label>
                        <textarea class="form-input" id="customMessage" rows="3" placeholder="전달하고 싶은 말씀을 짧게 적어주세요."
                            style="resize: none;"></textarea>
                    </div>

                    <div class="form-check" style="margin-bottom: 20px;">
                        <input type="checkbox" id="privacyCheck">
                        <label for="privacyCheck">입력한 번호는 오직 합의 요청 발송 목적으로만 사용됨에 동의합니다.</label>
                    </div>

                    <button class="btn btn-primary" style="width: 100%;" id="sendInviteBtn" onclick="sendInvite()">
                        <i class="fas fa-paper-plane" style="margin-right: 8px;"></i> 합의 요청 보내기
                    </button>
                </div>

                <!-- Right: Preview -->
                <div
                    style="background: hsla(0,0%,100%,0.95); border-radius: 20px; padding: 20px; color: #333; height: fit-content; border: 4px solid #333;">
                    <div
                        style="text-align: center; margin-bottom: 15px; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                        미리보기 (수신자 화면)
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <div
                            style="width: 40px; height: 40px; background: #fee500; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                            <i class="fas fa-comment" style="color: #3b1e1e;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 0.9rem;">SafeSettlement (알림톡)</div>
                            <div
                                style="background: #fff; padding: 12px; border-radius: 0 12px 12px 12px; margin-top: 5px; font-size: 0.9rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee;">
                                [형사사건 비대면 합의 안내]<br><br>
                                <span id="previewNameArea"></span>귀하의 사건(<span id="previewCaseInfo">2024형제12345</span>)과
                                관련하여 비대면 합의 절차가 접수되었습니다.<br><br>
                                <div id="previewMessageArea"
                                    style="background: #f1f1f1; padding: 8px; border-radius: 4px; font-size: 0.85rem; color: #555; margin-bottom: 10px; display: none;">
                                </div>
                                본 플랫폼을 통해 직접적인 대면 없이, 감정 소모를 최소화하며 안전하게 합의를 진행할 수 있습니다.<br><br>
                                합의 AI가 제안하는 합리적인 절차에 따라 원만한 해결을 도와드립니다.<br><br>
                                ▶ 바로 접속하기:<br>
                                <span
                                    style="color: blue; text-decoration: underline;">https://safesettlement.co.kr</span><br>
                                (네이버 검색: "세이프세틀먼트")
                                <hr style="margin: 15px 0; border: none; border-top: 1px dashed #ddd;">
                                <div
                                    style="font-size: 0.8rem; color: #666; background: #fafafa; padding: 10px; border-radius: 8px;">
                                    <strong>SafeSettlement는?</strong><br>
                                    안전하고 체계적인 비대면 합의 중재 플랫폼입니다.
                                    감정 소모 없이 공정한 보상을 논의하고, 피해 회복에 집중하실 수 있도록 돕겠습니다.
                                </div>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 0.75rem; color: #666; text-align: center;">
                        * 실제로는 카카오톡 알림톡 또는 LMS로 발송됩니다.
                    </p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Update Preview Real-time
        document.getElementById('senderName').addEventListener('input', updatePreview);
        document.getElementById('customMessage').addEventListener('input', updatePreview);
        document.getElementById('caseInfoInput').addEventListener('input', updatePreview);

        function updatePreview() {
            const name = document.getElementById('senderName').value;
            const msg = document.getElementById('customMessage').value;
            const caseInfo = document.getElementById('caseInfoInput').value;

            const nameArea = document.getElementById('previewNameArea');
            const msgArea = document.getElementById('previewMessageArea');
            const caseInfoArea = document.getElementById('previewCaseInfo');

            if (name) {
                nameArea.innerHTML = `<strong>${name}</strong>님으로부터 `;
            } else {
                nameArea.innerHTML = '';
            }

            if (msg) {
                msgArea.style.display = 'block';
                msgArea.innerText = `"${msg}"`;
            } else {
                msgArea.style.display = 'none';
            }

            if (caseInfo) {
                caseInfoArea.innerText = caseInfo;
            } else {
                caseInfoArea.innerText = "사건 정보 없음";
            }
        }

        async function sendInvite() {
            const phone = document.getElementById('victimPhone').value;
            const senderName = document.getElementById('senderName').value;
            const customMessage = document.getElementById('customMessage').value;
            const caseInfo = document.getElementById('caseInfoInput').value;
            const privacy = document.getElementById('privacyCheck').checked;

            if (phone.length < 10) {
                alert('유효한 휴대폰 번호를 입력해주세요.');
                return;
            }
            if (!privacy) {
                alert('개인정보 사용 동의가 필요합니다.');
                return;
            }

            const btn = document.getElementById('sendInviteBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 발송중...';
            btn.disabled = true;

            try {
                const res = await fetch('http://localhost:3000/api/case/invite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caseNumber: caseInfo, // Using the user edited info
                        victimPhone: phone,
                        senderName: senderName || '익명',
                        customMessage: customMessage
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('요청이 안전하게 발송되었습니다.\n(서버 콘솔에서 발송 내용을 확인하세요)');
                    location.href = 'dashboard.html';
                } else {
                    // If case not found (which might happen if arbitrary text), we might want to handle it or just suppress.
                    // But in our server update below, we will make it non-strict.
                    alert('발송 실패: ' + (data.error || '알 수 없는 오류'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i> 합의 요청 보내기';
                }
            } catch (err) {
                console.error(err);
                alert('서버 연결 오류입니다.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane" style="margin-right: 8px;"></i> 익명 요청 보내기';
            }
        }
    </script>
</body>

</html>